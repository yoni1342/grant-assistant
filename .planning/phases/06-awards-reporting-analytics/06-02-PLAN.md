---
phase: 06-awards-reporting-analytics
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - app/(dashboard)/awards/page.tsx
  - app/(dashboard)/awards/components/awards-page-client.tsx
  - app/(dashboard)/awards/components/award-table.tsx
  - app/(dashboard)/awards/new/page.tsx
  - app/(dashboard)/awards/new/new-award-client.tsx
  - app/(dashboard)/awards/[id]/page.tsx
  - app/(dashboard)/awards/[id]/components/award-detail-client.tsx
  - app/(dashboard)/awards/[id]/components/reporting-calendar.tsx
  - app/(dashboard)/awards/[id]/components/report-list.tsx
  - app/(dashboard)/awards/[id]/components/report-editor.tsx
autonomous: true

must_haves:
  truths:
    - "User can see a list of awards with grant name, amount, period, and status"
    - "User can create a new award linked to a grant with amount, dates, and requirements"
    - "User can view award detail with reporting calendar showing interim and final report due dates"
    - "User can trigger AI report generation and see progress"
    - "User can view and edit AI-generated report content with Tiptap editor and autosave"
    - "User can manually create report records with due dates"
  artifacts:
    - path: "app/(dashboard)/awards/page.tsx"
      provides: "Awards list server component"
    - path: "app/(dashboard)/awards/components/award-table.tsx"
      provides: "TanStack Table for awards list"
      min_lines: 50
    - path: "app/(dashboard)/awards/new/new-award-client.tsx"
      provides: "Award creation form with date pickers"
      min_lines: 60
    - path: "app/(dashboard)/awards/[id]/components/award-detail-client.tsx"
      provides: "Award detail with reporting and actions"
      min_lines: 80
    - path: "app/(dashboard)/awards/[id]/components/reporting-calendar.tsx"
      provides: "Calendar with deadline highlighting"
      min_lines: 40
    - path: "app/(dashboard)/awards/[id]/components/report-editor.tsx"
      provides: "Tiptap editor for report content with debounced autosave"
      min_lines: 50
  key_links:
    - from: "app/(dashboard)/awards/page.tsx"
      to: "app/(dashboard)/awards/actions.ts"
      via: "getAwards() server action"
      pattern: "getAwards"
    - from: "app/(dashboard)/awards/[id]/components/award-detail-client.tsx"
      to: "app/(dashboard)/awards/reports-actions.ts"
      via: "triggerReportGeneration() server action"
      pattern: "triggerReportGeneration"
    - from: "app/(dashboard)/awards/[id]/components/report-editor.tsx"
      to: "app/(dashboard)/awards/reports-actions.ts"
      via: "updateReport() with debounced autosave"
      pattern: "updateReport"
---

<objective>
Build the complete Awards UI: list page with TanStack Table, create award form with Calendar date pickers, award detail page with reporting calendar, report generation trigger, and Tiptap report editor with debounced autosave.

Purpose: Users can record awards, view reporting deadlines, generate AI reports, and edit report content -- fulfilling AWRD-01 through AWRD-04.
Output: Complete awards management interface at /awards with list, create, and detail views.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-awards-reporting-analytics/06-RESEARCH.md
@.planning/phases/06-awards-reporting-analytics/06-01-SUMMARY.md
@app/(dashboard)/budgets/page.tsx
@app/(dashboard)/budgets/components/budget-page-client.tsx
@app/(dashboard)/budgets/components/budget-table.tsx
@app/(dashboard)/budgets/[id]/components/budget-detail-client.tsx
@app/(dashboard)/proposals/[id]/components/proposal-detail-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Awards list page and create award form</name>
  <files>
    app/(dashboard)/awards/page.tsx
    app/(dashboard)/awards/components/awards-page-client.tsx
    app/(dashboard)/awards/components/award-table.tsx
    app/(dashboard)/awards/new/page.tsx
    app/(dashboard)/awards/new/new-award-client.tsx
  </files>
  <action>
Replace the placeholder awards page and build the full list + create flow. Follow budget list page patterns exactly.

**1. `app/(dashboard)/awards/page.tsx`** - Server component:
- Call `getAwards()` server action
- Render `AwardsPageClient` with initial awards data

**2. `app/(dashboard)/awards/components/awards-page-client.tsx`** - Client wrapper:
- "use client" directive
- Realtime subscription on `awards` table for INSERT, UPDATE, DELETE events
- Call `router.refresh()` on any change
- Cleanup subscription on unmount with `removeChannel()`
- Page header: "Awards" title + "Record Award" button linking to `/awards/new`
- Render `AwardTable` with awards data

**3. `app/(dashboard)/awards/components/award-table.tsx`** - TanStack Table:
- Follow budget-table.tsx pattern exactly
- Columns:
  - Grant Title: `row.original.grants?.title` as link to `/awards/${row.original.id}`
  - Funder: `row.original.grants?.funder_name` (display "N/A" if null)
  - Amount: formatted with `formatCurrency()` from lib/utils/analytics.ts
  - Award Period: `format(parseISO(start_date), 'MMM yyyy') - format(parseISO(end_date), 'MMM yyyy')` using date-fns
  - Award Date: `format(parseISO(award_date), 'MMM d, yyyy')` (or "N/A")
- Global filter for search across all fields
- Sortable column headers
- Row click navigation to `/awards/{id}`
- Empty state: "No awards recorded yet. Record your first award."

**4. `app/(dashboard)/awards/new/page.tsx`** - Server component:
- Fetch grants that are in 'awarded' stage OR grants with no existing award (fetch all grants, fetch all awards, filter grants without award)
- Actually simpler: fetch grants for the org, pass to client. Let user pick any grant.
- Render `NewAwardClient` with grants list

**5. `app/(dashboard)/awards/new/new-award-client.tsx`** - Client component:
- "use client" directive
- React Hook Form with Zod validation:
  - grant_id: z.string().min(1, "Select a grant")
  - amount: z.number().min(1, "Amount must be greater than 0")
  - award_date: z.date() (use Calendar in Popover for date picking, follow research Pattern 3)
  - start_date: z.date()
  - end_date: z.date()
  - requirements: z.string().optional()
- Grant selector: Select dropdown with grant titles
- Three date pickers using shadcn Calendar in Popover (award_date, start_date, end_date). Pattern from research:
  ```
  <Popover>
    <PopoverTrigger asChild>
      <Button variant="outline">{field.value ? format(field.value, "PPP") : "Pick a date"} <CalendarIcon /></Button>
    </PopoverTrigger>
    <PopoverContent className="w-auto p-0" align="start">
      <Calendar mode="single" selected={field.value} onSelect={field.onChange} />
    </PopoverContent>
  </Popover>
  ```
- Amount input: type="number" with parseFloat conversion (same as budget form)
- Requirements: Textarea for reporting requirements text
- On submit: call `createAward()` server action, show toast, redirect to `/awards`
- Import CalendarIcon from lucide-react
  </action>
  <verify>
`npx tsc --noEmit` passes. Awards list page at `/awards` renders TanStack table. New award page at `/awards/new` renders form with date pickers. All 5 files exist and export their components.
  </verify>
  <done>
Awards list page shows TanStack table with grant title, amount, period, and date. New award form has grant selector, three Calendar date pickers, amount input, and requirements textarea. Realtime subscription refreshes list on changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Award detail page with reporting calendar, report list, and report editor</name>
  <files>
    app/(dashboard)/awards/[id]/page.tsx
    app/(dashboard)/awards/[id]/components/award-detail-client.tsx
    app/(dashboard)/awards/[id]/components/reporting-calendar.tsx
    app/(dashboard)/awards/[id]/components/report-list.tsx
    app/(dashboard)/awards/[id]/components/report-editor.tsx
  </files>
  <action>
Build the award detail page with reporting calendar, report management, and Tiptap report editing. Follow proposal detail and budget detail patterns.

**1. `app/(dashboard)/awards/[id]/page.tsx`** - Server component:
- Call `getAward(params.id)` - returns award with grant data and reports
- If null, call `notFound()`
- Render `AwardDetailClient` with award, grant, and reports data

**2. `app/(dashboard)/awards/[id]/components/award-detail-client.tsx`** - Client wrapper:
- "use client" directive
- Two-column layout (lg:grid-cols-3):
  - Left column (col-span-2): Award info card + Report list + Report editor (if a report is selected)
  - Right column (col-span-1): Reporting calendar + Actions

- Award info card (Card component):
  - Title: grant title
  - Details: Amount (formatted), Award Date, Period (start - end), Requirements text
  - "Edit Award" button (optional - could just show info for v1, editing is lower priority)
  - "Delete Award" with AlertDialog confirmation, calls deleteAward(), redirects to /awards

- Actions section:
  - "Add Report" button: opens a dialog (shadcn Dialog) with form to create a new report:
    - report_type: Select (interim / final)
    - title: Input
    - due_date: Calendar date picker in Popover
    - On submit: call `createReport()`, show toast, router.refresh()
  - "Generate Report" button: Select which existing report to generate for (dropdown of draft reports), calls `triggerReportGeneration(awardId, reportId)`. Shows WorkflowProgress component after triggering.

- Realtime subscriptions on `awards` table (filter by award id) AND `reports` table (filter by award_id). Call router.refresh() on any change. Cleanup on unmount.

- State: `selectedReportId` for which report is being edited

**3. `app/(dashboard)/awards/[id]/components/reporting-calendar.tsx`** - Calendar display:
- Receives reports array as prop
- Uses shadcn Calendar component with modifiers to highlight dates:
  - `deadline` modifier: all report due_dates (bold, underline)
  - `overdue` modifier: reports that are draft/pending AND due_date < today (destructive background, white text)
  - `completed` modifier: reports with status 'submitted' (green indicator or different style)
- On date select: if a report exists on that date, call onSelectReport(reportId) callback to open editor
- Below calendar: list of reports with due_date, type badge (interim/final with destructive for final, secondary for interim), title, and status icon (CheckCircle2 for submitted, Clock for draft, AlertTriangle for overdue draft)
- Use date-fns parseISO, isSameDay, format, isBefore

**4. `app/(dashboard)/awards/[id]/components/report-list.tsx`** - Report listing:
- Receives reports array and selectedReportId, onSelectReport callback
- Shows reports in a list with:
  - Type badge (interim/final)
  - Title
  - Due date formatted
  - Status badge (draft/submitted/overdue)
  - Click to select (calls onSelectReport)
- Selected report highlighted with ring-2 border
- Empty state: "No reports yet. Add a report above."

**5. `app/(dashboard)/awards/[id]/components/report-editor.tsx`** - Tiptap report editor:
- Receives report object (id, content, title, status)
- Tiptap editor with StarterKit, Placeholder extension (placeholder: "Start writing your report...")
- immediatelyRender: false (SSR compatibility, same as narrative editor)
- Toolbar: Bold, Italic, Heading (H2, H3), BulletList, OrderedList, Blockquote (same as narrative editor)
- Debounced autosave: useDebouncedCallback from use-debounce (2 second delay, same as proposal section editor)
  - On editor update, call debounced function that calls `updateReport(reportId, { content: editor.getHTML() })`
  - Show "Saving..." indicator during save, "Saved" after
- "Mark as Submitted" button: calls `updateReport(reportId, { status: 'submitted', submitted_at: new Date().toISOString() })`, shows toast
- Header shows report title and type badge
- Content area: prose styling `prose prose-sm focus:outline-none min-h-[400px] p-4`
  </action>
  <verify>
`npx tsc --noEmit` passes. Award detail page at `/awards/{id}` renders with award info, reporting calendar, report list, and report editor. Calendar highlights report due dates. Editor saves on 2-second debounce. All 5 files exist.
  </verify>
  <done>
Award detail page shows award info, reporting calendar with highlighted deadlines, report list with type/status badges, and Tiptap report editor with debounced autosave. Users can add reports, generate AI reports with WorkflowProgress tracking, and edit report content inline. Realtime subscriptions update both awards and reports live.
  </done>
</task>

</tasks>

<verification>
1. Awards list page at /awards shows TanStack table with all recorded awards
2. "Record Award" at /awards/new has grant selector, Calendar date pickers, amount, requirements
3. Award detail at /awards/{id} shows award info card with formatted data
4. Reporting calendar highlights due dates with color-coded modifiers (overdue, upcoming, completed)
5. Report list shows all reports with type badges and status
6. "Add Report" creates new report record
7. "Generate Report" triggers n8n workflow and shows WorkflowProgress
8. Report editor uses Tiptap with debounced autosave (2 seconds)
9. "Mark as Submitted" updates report status
10. Realtime subscriptions on awards and reports tables
11. `npx tsc --noEmit` passes with zero errors
</verification>

<success_criteria>
Complete award management UI: list page, create form with date pickers, detail page with reporting calendar and deadlines, report generation with workflow progress, and report editing with Tiptap autosave. Fulfills AWRD-01 (record awards), AWRD-02 (reporting calendar), AWRD-03 (AI report generation), AWRD-04 (view/edit reports).
</success_criteria>

<output>
After completion, create `.planning/phases/06-awards-reporting-analytics/06-02-SUMMARY.md`
</output>
