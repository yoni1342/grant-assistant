---
phase: 06-awards-reporting-analytics
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - app/(dashboard)/analytics/page.tsx
  - app/(dashboard)/analytics/components/metrics-cards.tsx
  - app/(dashboard)/analytics/components/analytics-charts.tsx
  - app/(dashboard)/analytics/components/pipeline-breakdown.tsx
autonomous: true

must_haves:
  truths:
    - "User sees win rate as percentage (awards / submissions)"
    - "User sees total pipeline value (sum of pending grant amounts)"
    - "User sees average time from discovery to submission in days"
    - "User sees success rate broken down by funder type in a bar chart"
  artifacts:
    - path: "app/(dashboard)/analytics/page.tsx"
      provides: "Analytics dashboard server component"
      min_lines: 30
    - path: "app/(dashboard)/analytics/components/metrics-cards.tsx"
      provides: "KPI metric cards display"
      min_lines: 40
    - path: "app/(dashboard)/analytics/components/analytics-charts.tsx"
      provides: "Recharts bar chart for success rate by funder"
      min_lines: 40
    - path: "app/(dashboard)/analytics/components/pipeline-breakdown.tsx"
      provides: "Pipeline stage breakdown display"
      min_lines: 30
  key_links:
    - from: "app/(dashboard)/analytics/page.tsx"
      to: "app/(dashboard)/analytics/actions.ts"
      via: "getAnalytics() and getSuccessRateByFunder() server actions"
      pattern: "getAnalytics|getSuccessRateByFunder"
    - from: "app/(dashboard)/analytics/components/analytics-charts.tsx"
      to: "components/ui/chart.tsx"
      via: "ChartContainer, ChartTooltip imports"
      pattern: "ChartContainer|ChartTooltip"
---

<objective>
Build the analytics dashboard with server-side metric calculations, KPI cards, and Recharts charts for success rate by funder type.

Purpose: Users can track performance with win rate, pipeline value, time-to-submission, and funder success breakdown -- fulfilling ANLZ-01 through ANLZ-04.
Output: Analytics dashboard page at /analytics with metrics cards and charts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-awards-reporting-analytics/06-RESEARCH.md
@.planning/phases/06-awards-reporting-analytics/06-01-SUMMARY.md
@components/ui/chart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analytics page with metrics cards</name>
  <files>
    app/(dashboard)/analytics/page.tsx
    app/(dashboard)/analytics/components/metrics-cards.tsx
    app/(dashboard)/analytics/components/pipeline-breakdown.tsx
  </files>
  <action>
Create the analytics dashboard page as a React Server Component that fetches metrics server-side.

**1. `app/(dashboard)/analytics/page.tsx`** - Server component:
- Call `getAnalytics()` and `getSuccessRateByFunder()` server actions from `app/(dashboard)/analytics/actions.ts`
- Use Promise.all for parallel fetching
- Also fetch pipeline breakdown: query grants grouped by stage. Use Supabase: fetch all grants for org, group client-side by stage (discovery, screening, drafting, submission, awarded, reporting, closed), count per stage.
- Render:
  - Page header: "Analytics" title with subtitle "Performance metrics and pipeline insights"
  - MetricsCards component with analytics data
  - Two-column grid (lg:grid-cols-2):
    - AnalyticsCharts with funder success rate data
    - PipelineBreakdown with stage counts
- No Realtime subscription needed (analytics page loads fresh on each visit per research recommendation)

**2. `app/(dashboard)/analytics/components/metrics-cards.tsx`** - Client component:
- "use client" directive
- Receives props: winRate, pipelineValue, totalSubmissions, totalAwards, totalAwardAmount, avgTimeToSubmission
- Four metric cards in a responsive grid (grid-cols-2 md:grid-cols-4):
  - **Win Rate**: Show as `{winRate}%` in large text, subtitle "Awards / Submissions ({totalAwards}/{totalSubmissions})", icon: Trophy from lucide-react
  - **Pipeline Value**: Show as `formatCurrency(pipelineValue)` in large text, subtitle "Active grants in pipeline", icon: DollarSign from lucide-react
  - **Avg Time to Submit**: Show as `{avgTimeToSubmission} days` in large text, subtitle "Discovery to submission", icon: Clock from lucide-react
  - **Total Awarded**: Show as `formatCurrency(totalAwardAmount)` in large text, subtitle "{totalAwards} grants awarded", icon: Award from lucide-react
- Each card uses shadcn Card component with CardHeader (icon + title) and CardContent (value + subtitle)
- Import formatCurrency from lib/utils/analytics.ts

**3. `app/(dashboard)/analytics/components/pipeline-breakdown.tsx`** - Client component:
- "use client" directive
- Receives props: stages (Array of { stage: string, count: number })
- Card with title "Pipeline Breakdown"
- List of stages with:
  - Stage name (capitalized)
  - Count badge
  - Progress bar (percentage of total) using shadcn Progress component
- Color-code stages: discovery (blue), screening (yellow), drafting (purple), submission (orange), awarded (green), reporting (teal), closed (gray)
- Use inline styles or className for stage colors with bg-{color}-500 patterns
  </action>
  <verify>
`npx tsc --noEmit` passes. Analytics page at `/analytics` renders with 4 metric cards and pipeline breakdown. All 3 files exist and export their components.
  </verify>
  <done>
Analytics page shows 4 KPI cards (win rate, pipeline value, avg time to submit, total awarded) and pipeline stage breakdown with progress bars. All metrics calculated server-side.
  </done>
</task>

<task type="auto">
  <name>Task 2: Success rate by funder chart with Recharts</name>
  <files>
    app/(dashboard)/analytics/components/analytics-charts.tsx
  </files>
  <action>
Create the analytics charts component using shadcn chart (Recharts wrapper).

**`app/(dashboard)/analytics/components/analytics-charts.tsx`** - Client component:
- "use client" directive
- Receives props: funderData (Array of { funderName: string, awards: number, submissions: number, successRate: number })
- Card with title "Success Rate by Funder"
- Handle empty state: if funderData is empty or all zeros, show "No submission data yet. Submit grants to see success rates."
- Bar chart using shadcn chart components (follow research Pattern 2 exactly):
  ```typescript
  import { Bar, BarChart, CartesianGrid, XAxis, YAxis } from "recharts"
  import { ChartContainer, ChartTooltip, ChartTooltipContent } from "@/components/ui/chart"
  ```
- Chart config:
  ```typescript
  const chartConfig = {
    successRate: {
      label: "Success Rate",
      color: "hsl(var(--chart-1))",
    },
  } satisfies ChartConfig
  ```
- ChartContainer with config and className="min-h-[300px]"
- BarChart with accessibilityLayer prop for keyboard/screen reader support
- CartesianGrid with vertical={false}
- XAxis: dataKey="funderName", tickLine={false}, tickMargin={10}, axisLine={false}, tickFormatter to truncate names > 12 chars
- YAxis: tickFormatter to append "%" to values
- ChartTooltip with ChartTooltipContent, formatter to show "{value}% success rate"
- Bar: dataKey="successRate", fill="var(--color-successRate)", radius={[4, 4, 0, 0]}
- Below chart, show a summary row: "Based on {totalSubmissions} submissions across {funderCount} funders"
- Import ChartConfig type from chart component
  </action>
  <verify>
`npx tsc --noEmit` passes. Analytics charts component renders bar chart with success rate data. File exists and exports AnalyticsCharts component.
  </verify>
  <done>
Success rate by funder bar chart renders with Recharts via shadcn chart components. Accessible, responsive, with tooltips showing percentage values. Handles empty state gracefully.
  </done>
</task>

</tasks>

<verification>
1. Analytics page at /analytics loads with server-side metric calculations
2. Win rate card shows percentage (ANLZ-01)
3. Pipeline value card shows formatted currency total (ANLZ-02)
4. Average time to submission card shows days (ANLZ-03)
5. Success rate by funder bar chart renders with Recharts (ANLZ-04)
6. Pipeline breakdown shows grants by stage with progress bars
7. Empty states handled gracefully for all components
8. Charts use shadcn chart components (ChartContainer, ChartTooltip)
9. Charts have accessibilityLayer prop for keyboard/screen reader support
10. `npx tsc --noEmit` passes with zero errors
</verification>

<success_criteria>
Analytics dashboard displays all four required metrics: win rate (ANLZ-01), pipeline value (ANLZ-02), average time to submission (ANLZ-03), and success rate by funder type as a bar chart (ANLZ-04). All calculations happen server-side. Charts use shadcn/Recharts with accessibility support.
</success_criteria>

<output>
After completion, create `.planning/phases/06-awards-reporting-analytics/06-03-SUMMARY.md`
</output>
