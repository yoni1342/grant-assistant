---
phase: 06-awards-reporting-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(dashboard)/awards/actions.ts
  - app/(dashboard)/awards/reports-actions.ts
  - app/(dashboard)/analytics/actions.ts
  - lib/utils/analytics.ts
  - app/api/webhook/route.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Award CRUD server actions exist and handle create, read, update, delete"
    - "Report CRUD server actions exist with AI generation trigger"
    - "Analytics server actions calculate win rate, pipeline value, time-to-submission, and success rate by funder"
    - "Webhook route handles n8n callbacks for awards and reports"
    - "shadcn chart and calendar components are installed"
  artifacts:
    - path: "app/(dashboard)/awards/actions.ts"
      provides: "Award CRUD server actions"
      exports: ["getAwards", "getAward", "createAward", "updateAward", "deleteAward"]
    - path: "app/(dashboard)/awards/reports-actions.ts"
      provides: "Report CRUD and AI generation server actions"
      exports: ["getReports", "getReport", "createReport", "updateReport", "deleteReport", "triggerReportGeneration"]
    - path: "app/(dashboard)/analytics/actions.ts"
      provides: "Analytics metric calculation server actions"
      exports: ["getAnalytics", "getSuccessRateByFunder"]
    - path: "lib/utils/analytics.ts"
      provides: "Analytics calculation helpers"
      exports: ["calculateAvgTimeToSubmission", "formatCurrency"]
    - path: "app/api/webhook/route.ts"
      provides: "Extended webhook handler for awards and reports"
      contains: "insert_award|update_award|insert_report|update_report"
  key_links:
    - from: "app/(dashboard)/awards/reports-actions.ts"
      to: "N8N_WEBHOOK_URL/draft-report"
      via: "fire-and-forget fetch"
      pattern: "fetch.*draft-report"
    - from: "app/api/webhook/route.ts"
      to: "awards and reports tables"
      via: "service-role Supabase client"
      pattern: "case.*insert_award|insert_report|update_report"
---

<objective>
Install Phase 6 dependencies (shadcn chart + calendar), create all award, report, and analytics server actions, and extend the webhook route for n8n award/report callbacks.

Purpose: Establish the complete data layer and dependencies before building award UI and analytics dashboard.
Output: Server actions, webhook handlers, analytics utilities, and UI component dependencies ready for Phase 6 UI plans.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-awards-reporting-analytics/06-RESEARCH.md
@.planning/phases/05-budget-builder-submission-tracking/05-01-SUMMARY.md
@app/api/webhook/route.ts
@app/(dashboard)/budgets/actions.ts
@app/(dashboard)/submissions/actions.ts
@lib/utils/urgency.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn chart and calendar components</name>
  <files>
    package.json
    components/ui/chart.tsx
    components/ui/calendar.tsx
  </files>
  <action>
Install shadcn chart and calendar components:

```bash
npx shadcn@latest add chart calendar
```

This installs recharts and react-day-picker as dependencies, plus the shadcn wrapper components (ChartContainer, ChartTooltip, ChartTooltipContent for charts; Calendar component for date picking).

Verify both components exist after installation. These are used in Plans 06-02 (reporting calendar, date pickers) and 06-03 (analytics charts).
  </action>
  <verify>
`npm ls recharts react-day-picker` shows both installed. `ls components/ui/chart.tsx components/ui/calendar.tsx` shows both files exist.
  </verify>
  <done>
shadcn chart and calendar components installed with recharts and react-day-picker dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create award, report, and analytics server actions with webhook extensions</name>
  <files>
    app/(dashboard)/awards/actions.ts
    app/(dashboard)/awards/reports-actions.ts
    app/(dashboard)/analytics/actions.ts
    lib/utils/analytics.ts
    app/api/webhook/route.ts
  </files>
  <action>
Create four new files and extend one existing file. Follow the exact patterns from `app/(dashboard)/budgets/actions.ts` (auth check, org_id lookup from profiles, revalidatePath).

**1. `app/(dashboard)/awards/actions.ts`** - Award CRUD server actions:

- `getAwards()`: Fetch all awards for user's org, join with grants (title, funder_name, amount), ordered by award_date desc.
- `getAward(awardId: string)`: Fetch single award by ID with grant join (title, funder_name, deadline, source_url). Return null if not found (like getFunder pattern from Phase 4). Also fetch related reports via separate query on reports table filtered by award_id, ordered by due_date asc.
- `createAward(data: { grant_id, amount, award_date, start_date, end_date, requirements })`: Insert award record. Also update the grant's stage to 'awarded' via separate update. Fire-and-forget to `N8N_WEBHOOK_URL + '/record-award'` with awardId and grantId (n8n creates reporting calendar). revalidatePath('/awards').
- `updateAward(awardId: string, data)`: Update award fields. revalidatePath for the detail page.
- `deleteAward(awardId: string)`: Delete award. revalidatePath('/awards').

Auth pattern (copy from budgets/actions.ts):
```typescript
const supabase = await createClient()
const { data: { user } } = await supabase.auth.getUser()
if (!user) throw new Error('Not authenticated')
const { data: profile } = await supabase.from('profiles').select('org_id').eq('id', user.id).single()
if (!profile?.org_id) throw new Error('No organization')
```

**2. `app/(dashboard)/awards/reports-actions.ts`** - Report server actions:

- `getReports(awardId: string)`: Fetch all reports for an award, ordered by due_date asc.
- `getReport(reportId: string)`: Fetch single report with award and grant joins. Return null if not found.
- `createReport(data: { award_id, grant_id, report_type: 'interim' | 'final', title, due_date })`: Insert report with status 'draft'.
- `updateReport(reportId: string, data: { title?, content?, status? })`: Update report. Skip revalidatePath when only content changes (autosave pattern from Phase 4 updateProposalSection). Call revalidatePath when status changes.
- `deleteReport(reportId: string)`: Delete report.
- `triggerReportGeneration(awardId: string, reportId: string)`: Insert workflow_executions record with workflow_name 'report_generation', grant_id from the award, metadata { award_id, report_id }. Fire-and-forget fetch to `N8N_WEBHOOK_URL + '/draft-report'` with executionId, awardId, reportId. Return { workflowId: execution.id }.

**3. `app/(dashboard)/analytics/actions.ts`** - Analytics server actions:

- `getAnalytics()`: Server action that calculates all four metrics using server-side Supabase queries:
  - Win rate: `count(submissions)` and `count(awards)` with head: true for efficient counting. winRate = awards > 0 && submissions > 0 ? Math.round((awards / submissions) * 100) : 0
  - Pipeline value: Fetch grants with stage in ('discovery', 'screening', 'drafting', 'submission'), sum amounts client-side (Supabase JS doesn't support aggregate sum directly). Use reduce.
  - Total awards count and total award amount: Fetch awards, sum amounts.
  - Avg time to submission: Call `calculateAvgTimeToSubmission()` helper from lib/utils/analytics.ts
  - Return object: `{ winRate, pipelineValue, totalSubmissions, totalAwards, totalAwardAmount, avgTimeToSubmission }`

- `getSuccessRateByFunder()`: Fetch awards with grant joins (funder_name) and submissions with grant joins (funder_name). Group by funder_name, calculate success rate per funder. Return array of `{ funderName, awards, submissions, successRate }`.

**4. `lib/utils/analytics.ts`** - Analytics helpers:

- `calculateAvgTimeToSubmission(grants: Array<{ created_at: string, submissions?: Array<{ submitted_at: string }> }>)`: Filter grants with submissions, calculate differenceInDays for each, return average rounded to integer. Import differenceInDays from date-fns. Return 0 if no data.
- `formatCurrency(amount: number)`: Return formatted string like "$1,234,567" using Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).

**5. Extend `app/api/webhook/route.ts`** - Add 4 new cases to the switch statement:

- `insert_award`: Insert into awards table with data fields (grant_id, org_id, amount, award_date, start_date, end_date, requirements).
- `update_award`: Update awards table by id with spread data fields.
- `insert_report`: Insert into reports table with data fields (award_id, grant_id, org_id, report_type, title, content, due_date, status).
- `update_report`: Update reports table by id with spread data fields. Used by n8n to write AI-generated report content back.

Follow existing webhook handler patterns exactly (destructure data, use service-role client, throw on error).
  </action>
  <verify>
`npx tsc --noEmit` passes with zero errors. All 5 award actions exported from actions.ts. All 6 report actions exported from reports-actions.ts. Both analytics actions exported. Webhook route contains all 4 new case handlers (17 total cases).
  </verify>
  <done>
Award CRUD (5 actions), report management (6 actions), analytics calculations (2 actions), analytics helpers (2 functions), and 4 webhook handlers all created and type-check clean.
  </done>
</task>

</tasks>

<verification>
1. `npm ls recharts react-day-picker` - Chart and calendar deps installed
2. `ls components/ui/chart.tsx components/ui/calendar.tsx` - UI components exist
3. `npx tsc --noEmit` - Zero TypeScript errors
4. Award actions file exports: getAwards, getAward, createAward, updateAward, deleteAward
5. Report actions file exports: getReports, getReport, createReport, updateReport, deleteReport, triggerReportGeneration
6. Analytics actions file exports: getAnalytics, getSuccessRateByFunder
7. Analytics utils exports: calculateAvgTimeToSubmission, formatCurrency
8. Webhook route contains insert_award, update_award, insert_report, update_report handlers
</verification>

<success_criteria>
All Phase 6 server actions, webhook handlers, analytics utilities, and UI dependencies installed and type-checking clean. No UI work in this plan - pure data layer and dependency setup.
</success_criteria>

<output>
After completion, create `.planning/phases/06-awards-reporting-analytics/06-01-SUMMARY.md`
</output>
