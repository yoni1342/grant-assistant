---
phase: 04-eligibility-screening-proposal-generation
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/(dashboard)/proposals/page.tsx
  - app/(dashboard)/proposals/components/proposal-table.tsx
  - app/(dashboard)/proposals/components/proposals-page-client.tsx
  - app/(dashboard)/pipeline/[id]/grant-detail.tsx
  - app/(dashboard)/pipeline/[id]/components/generate-proposal-button.tsx
  - app/(dashboard)/pipeline/[id]/components/workflow-progress.tsx
  - app/(dashboard)/pipeline/[id]/components/funder-analysis-button.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a list of all proposals with grant name, status, quality score, and dates"
    - "User can trigger one-click AI proposal generation from the grant detail page"
    - "User sees proposal generation progress updating in real-time (not infinite spinner)"
    - "User can trigger funder analysis from the grant detail page"
    - "User can navigate from proposal list to proposal detail"
  artifacts:
    - path: "app/(dashboard)/proposals/page.tsx"
      provides: "Server component fetching proposals list"
    - path: "app/(dashboard)/proposals/components/proposal-table.tsx"
      provides: "TanStack table displaying proposals with columns and actions"
    - path: "app/(dashboard)/pipeline/[id]/components/generate-proposal-button.tsx"
      provides: "One-click proposal generation trigger with workflow progress"
    - path: "app/(dashboard)/pipeline/[id]/components/workflow-progress.tsx"
      provides: "Realtime workflow status indicator"
    - path: "app/(dashboard)/pipeline/[id]/components/funder-analysis-button.tsx"
      provides: "Funder analysis trigger button"
  key_links:
    - from: "app/(dashboard)/pipeline/[id]/components/generate-proposal-button.tsx"
      to: "app/(dashboard)/proposals/actions.ts"
      via: "triggerProposalGeneration server action"
      pattern: "triggerProposalGeneration"
    - from: "app/(dashboard)/pipeline/[id]/components/workflow-progress.tsx"
      to: "workflow_executions table"
      via: "Supabase Realtime postgres_changes subscription"
      pattern: "postgres_changes.*workflow_executions"
    - from: "app/(dashboard)/pipeline/[id]/components/funder-analysis-button.tsx"
      to: "app/(dashboard)/proposals/actions.ts"
      via: "triggerFunderAnalysis server action"
      pattern: "triggerFunderAnalysis"
---

<objective>
Build the proposals list page with TanStack table and add proposal generation + funder analysis triggers to the grant detail page with real-time workflow progress tracking.

Purpose: Users need to see all their proposals in one place and trigger AI proposal generation from any grant. Real-time progress tracking ensures users know n8n is working (not infinite spinner).
Output: Functional proposals list page, generate proposal button on grant detail, funder analysis button, real-time workflow progress indicator.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-eligibility-screening-proposal-generation/04-RESEARCH.md
@.planning/phases/04-eligibility-screening-proposal-generation/04-01-SUMMARY.md
@app/(dashboard)/proposals/actions.ts
@app/(dashboard)/proposals/page.tsx
@app/(dashboard)/pipeline/[id]/page.tsx
@app/(dashboard)/pipeline/[id]/grant-detail.tsx
@app/(dashboard)/documents/components/document-table.tsx
@app/(dashboard)/narratives/components/narrative-list.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build proposals list page with TanStack table</name>
  <files>
    app/(dashboard)/proposals/page.tsx
    app/(dashboard)/proposals/components/proposal-table.tsx
    app/(dashboard)/proposals/components/proposals-page-client.tsx
  </files>
  <action>
    **Replace the placeholder `app/(dashboard)/proposals/page.tsx`** with a server component that:
    - Calls `getProposals()` from `./actions`
    - Passes proposals data to a client wrapper component
    - Shows page header "Proposals" with subtitle

    **Create `app/(dashboard)/proposals/components/proposals-page-client.tsx`** as client wrapper that:
    - Receives proposals array from server component
    - Renders ProposalTable component
    - Sets up Supabase Realtime subscription on `proposals` table for INSERT/UPDATE/DELETE events (same pattern as document-table.tsx)
    - On INSERT: add to local state
    - On UPDATE: merge into local state
    - On DELETE: remove from local state
    - Cleanup channel on unmount with `supabase.removeChannel(channel)`

    **Create `app/(dashboard)/proposals/components/proposal-table.tsx`** using TanStack Table (follow document-table.tsx pattern):

    Columns:
    1. **Title** - proposal title, clickable link to `/proposals/{id}`
    2. **Grant** - grant title (from joined data), text-muted-foreground
    3. **Status** - Badge with color: draft=secondary, generating=outline with Loader2 spinner, review=outline, final=default
    4. **Quality Score** - Display score as `{score}/100` with color coding (green >=80, yellow >=60, red <60). Show "---" if null.
    5. **Created** - formatted with `format(date, 'MMM d, yyyy')` from date-fns
    6. **Actions** - DropdownMenu with: "View" (link to /proposals/{id}), "Delete" (with confirmation)

    Table features:
    - Global filter for search (same pattern as document-table)
    - Sorting on all columns
    - Empty state: "No proposals yet. Generate your first proposal from a grant in the Pipeline."

    Use existing shadcn components: table, badge, dropdown-menu, button, input.
    Import from @tanstack/react-table: useReactTable, getCoreRowModel, getFilteredRowModel, getSortedRowModel, flexRender.

    Do NOT implement delete server action yet - just wire the UI button. The delete action will show a confirmation dialog and can be wired later.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors.
    Verify `app/(dashboard)/proposals/page.tsx` is a server component calling getProposals.
    Verify `app/(dashboard)/proposals/components/proposal-table.tsx` uses TanStack Table with 6 columns.
    Verify Realtime subscription present in proposals-page-client.tsx with cleanup.
  </verify>
  <done>
    Proposals list page shows all proposals in a searchable, sortable table with status badges, quality scores, and navigation to detail pages. Realtime updates keep the list in sync when n8n completes proposal generation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add proposal generation, funder analysis, and workflow progress to grant detail page</name>
  <files>
    app/(dashboard)/pipeline/[id]/grant-detail.tsx
    app/(dashboard)/pipeline/[id]/components/generate-proposal-button.tsx
    app/(dashboard)/pipeline/[id]/components/workflow-progress.tsx
    app/(dashboard)/pipeline/[id]/components/funder-analysis-button.tsx
  </files>
  <action>
    **Create `app/(dashboard)/pipeline/[id]/components/workflow-progress.tsx`** - Realtime workflow status indicator:
    - Props: `{ workflowId: string, workflowName: string, initialStatus: 'pending' | 'running' | 'completed' | 'failed' }`
    - Subscribe to Supabase Realtime `postgres_changes` on `workflow_executions` table filtered by `id=eq.${workflowId}`
    - Display status with Badge:
      - `running`: Badge variant="outline" with Loader2 animate-spin + "{workflowName}..."
      - `completed`: Badge with CheckCircle2 icon, text-green-600 + "Complete"
      - `failed`: Badge variant="destructive" with XCircle icon + "Failed"
      - `pending`: Badge variant="secondary" + "Queued"
    - Cleanup Realtime channel on unmount
    - When status transitions to 'completed', call `router.refresh()` to reload page data
    - Follow the exact Realtime pattern from Phase 3 narrative-list.tsx (channel name, event filter, cleanup)

    **Create `app/(dashboard)/pipeline/[id]/components/generate-proposal-button.tsx`**:
    - Props: `{ grantId: string, grantTitle: string }`
    - Button with Sparkles icon: "Generate Proposal"
    - On click: call `triggerProposalGeneration(grantId)` server action
    - While waiting for server action response: show Loader2 spinner, disable button
    - After response: render WorkflowProgress component with the returned workflowId
    - If error: show error text in red below button
    - If grant already has a proposal (check via optional `existingProposalId` prop), show "View Proposal" link instead with "Regenerate" as secondary action

    **Create `app/(dashboard)/pipeline/[id]/components/funder-analysis-button.tsx`**:
    - Props: `{ grantId: string, funderName: string, ein?: string }`
    - Button with Search icon: "Analyze Funder"
    - On click: call `triggerFunderAnalysis(grantId, funderName, ein)` server action
    - Show WorkflowProgress after trigger
    - Disable if no funderName provided (show tooltip: "Add a funder name first")

    **Modify `app/(dashboard)/pipeline/[id]/grant-detail.tsx`** to integrate the new buttons:
    - Add a new section after the screening result section titled "AI Tools"
    - Render GenerateProposalButton with `grantId={grant.id}` and `grantTitle={grant.title}`
    - Render FunderAnalysisButton with `grantId={grant.id}` and `funderName={grant.funder_name}` and `ein={grant.metadata?.ein}` (if available)
    - Show any existing proposals for this grant (query from page.tsx server component, pass as prop):
      - Modify `app/(dashboard)/pipeline/[id]/page.tsx` to also query proposals for this grant and pass to GrantDetail
    - If proposals exist, show a link "View Proposal" that navigates to `/proposals/{proposalId}`

    IMPORTANT PATTERNS:
    - Use `createClient` from `@/lib/supabase/client` for Realtime subscriptions (client-side)
    - Use `'use client'` directive on all new components
    - Import server actions from `@/app/(dashboard)/proposals/actions`
    - Realtime cleanup: `return () => { supabase.removeChannel(channel) }` in useEffect
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors.
    Verify generate-proposal-button.tsx calls triggerProposalGeneration and renders WorkflowProgress.
    Verify workflow-progress.tsx subscribes to Realtime postgres_changes on workflow_executions.
    Verify funder-analysis-button.tsx calls triggerFunderAnalysis.
    Verify grant-detail.tsx renders both new buttons in an "AI Tools" section.
  </verify>
  <done>
    Grant detail page has "Generate Proposal" and "Analyze Funder" buttons. Clicking generate creates a workflow execution, triggers n8n, and shows real-time progress (running -> completed/failed). Users see live status updates without polling. Funder analysis trigger works the same way.
  </done>
</task>

</tasks>

<verification>
1. Proposals page at `/proposals` shows table with proposal data (or empty state)
2. Grant detail page at `/pipeline/{id}` shows "Generate Proposal" and "Analyze Funder" buttons
3. Clicking "Generate Proposal" inserts a workflow_execution record and shows "Generating..." status
4. WorkflowProgress subscribes to Realtime and updates badge when workflow_executions status changes
5. Proposals list updates in real-time when new proposals are inserted by n8n
6. `npx tsc --noEmit` passes with zero errors
</verification>

<success_criteria>
- Proposals page replaces placeholder with searchable, sortable TanStack table
- One-click proposal generation from grant detail with real-time progress
- Funder analysis trigger from grant detail with real-time progress
- All Realtime subscriptions have proper cleanup
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-eligibility-screening-proposal-generation/04-02-SUMMARY.md`
</output>
