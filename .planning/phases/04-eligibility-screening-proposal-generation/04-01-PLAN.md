---
phase: 04-eligibility-screening-proposal-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - components/ui/accordion.tsx
  - components/ui/progress.tsx
  - app/(dashboard)/proposals/actions.ts
  - app/api/webhook/route.ts
autonomous: true

must_haves:
  truths:
    - "Server actions exist to trigger proposal generation, quality review, and funder analysis workflows"
    - "Server actions exist to update proposal section content"
    - "Webhook route handles insert_proposal, insert_proposal_sections, update_proposal, insert_funder, and update_funder actions from n8n"
    - "use-debounce package is installed for autosave throttling"
    - "shadcn accordion and progress components are available"
  artifacts:
    - path: "app/(dashboard)/proposals/actions.ts"
      provides: "All proposal and funder server actions"
      exports: ["getProposals", "getProposal", "triggerProposalGeneration", "triggerQualityReview", "triggerFunderAnalysis", "updateProposalSection", "reorderSections"]
    - path: "app/api/webhook/route.ts"
      provides: "Extended webhook handler for proposal and funder data from n8n"
      contains: "insert_proposal"
    - path: "components/ui/accordion.tsx"
      provides: "shadcn Accordion component"
    - path: "components/ui/progress.tsx"
      provides: "shadcn Progress component"
  key_links:
    - from: "app/(dashboard)/proposals/actions.ts"
      to: "workflow_executions table"
      via: "supabase insert then fire-and-forget fetch to n8n"
      pattern: "workflow_executions.*insert"
    - from: "app/api/webhook/route.ts"
      to: "proposals table"
      via: "service-role supabase client"
      pattern: "case.*insert_proposal"
---

<objective>
Install Phase 4 dependencies (use-debounce, shadcn accordion + progress), create all proposal/funder server actions, and extend the webhook route to handle n8n callbacks for proposal generation, quality review, and funder analysis.

Purpose: Establish the data layer and workflow triggers before building UI. All n8n workflow triggers and callbacks must work before the UI can consume them.
Output: Server actions for triggering all 4 workflows + reading/updating proposals. Webhook route extended with 5 new action cases.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-eligibility-screening-proposal-generation/04-RESEARCH.md
@app/api/webhook/route.ts
@app/(dashboard)/documents/actions.ts
@app/(dashboard)/narratives/actions.ts
@lib/supabase/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install use-debounce and add shadcn accordion + progress components</name>
  <files>
    package.json
    package-lock.json
    components/ui/accordion.tsx
    components/ui/progress.tsx
  </files>
  <action>
    Install the use-debounce package for autosave throttling in section editor:
    ```
    npm install use-debounce
    ```

    Add shadcn accordion and progress components:
    ```
    npx shadcn@latest add accordion progress
    ```

    Verify both components are created in components/ui/ directory.
    Verify use-debounce is in package.json dependencies.
  </action>
  <verify>
    Run `npm ls use-debounce` to confirm installation.
    Verify `components/ui/accordion.tsx` exists.
    Verify `components/ui/progress.tsx` exists.
    Run `npx tsc --noEmit` to confirm no type errors.
  </verify>
  <done>
    use-debounce installed, shadcn accordion and progress components available in components/ui/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create proposal server actions and extend webhook route</name>
  <files>
    app/(dashboard)/proposals/actions.ts
    app/api/webhook/route.ts
  </files>
  <action>
    **Create `app/(dashboard)/proposals/actions.ts`** with these server actions following the established pattern from `documents/actions.ts` and `narratives/actions.ts`:

    1. **`getProposals()`** - Fetch all proposals for the user's org, join with grants table to get grant title. Return `{ data, error }`.

    2. **`getProposal(proposalId: string)`** - Fetch single proposal with its sections (from `proposal_sections` ordered by `sort_order`) and related grant data. Return `{ data: { proposal, sections, grant }, error }`.

    3. **`triggerProposalGeneration(grantId: string)`** - Follow fire-and-forget pattern:
       - Get authenticated user + org_id from profiles
       - Insert `workflow_executions` record with: `{ org_id, grant_id: grantId, workflow_name: 'generate-proposal', status: 'running', webhook_url: '/webhook/generate-proposal' }`
       - Fire-and-forget fetch to `${N8N_WEBHOOK_URL}/generate-proposal` with `{ grant_id, workflow_id }` payload
       - Headers: `Content-Type: application/json`, `X-Webhook-Secret: ${N8N_WEBHOOK_SECRET}`
       - Return `{ success: true, workflowId }`

    4. **`triggerQualityReview(proposalId: string)`** - Same fire-and-forget pattern:
       - Get the proposal to find its grant_id
       - Insert `workflow_executions` with `workflow_name: 'review-proposal'`
       - Fire-and-forget fetch to `${N8N_WEBHOOK_URL}/review-proposal` with `{ proposal_id: proposalId, workflow_id }`
       - Return `{ success: true, workflowId }`

    5. **`triggerFunderAnalysis(grantId: string, funderName: string, ein?: string)`** - Same fire-and-forget pattern:
       - Insert `workflow_executions` with `workflow_name: 'analyze-funder'`
       - Fire-and-forget fetch to `${N8N_WEBHOOK_URL}/analyze-funder` with `{ grant_id: grantId, funder_name: funderName, ein, workflow_id }`
       - Return `{ success: true, workflowId }`

    6. **`updateProposalSection(sectionId: string, content: string)`** - Direct DB update:
       - Update `proposal_sections` where `id = sectionId` with `{ content }`
       - No revalidatePath (called from debounced autosave, don't want full page refresh)
       - Return `{ success: true }` or `{ error }`

    7. **`reorderSections(sectionUpdates: Array<{ id: string; sort_order: number }>)`** - Batch update sort_order:
       - Loop through sectionUpdates, update each `proposal_sections` row
       - revalidatePath('/proposals')
       - Return `{ success: true }` or `{ error }`

    8. **`getFunder(grantId: string)`** - Fetch funder for a grant's org:
       - Query `funders` table joining on org_id, optionally filtered by grant's funder_name
       - Return `{ data, error }`

    **Extend `app/api/webhook/route.ts`** by adding these cases to the existing switch statement (after the existing `update_document` case):

    ```typescript
    case 'insert_proposal': {
      const { data: proposal, error } = await supabase
        .from('proposals')
        .insert(data.proposal)
        .select()
        .single()
      if (error) throw error
      break
    }

    case 'insert_proposal_sections': {
      const { error } = await supabase
        .from('proposal_sections')
        .insert(data.sections)
      if (error) throw error
      break
    }

    case 'update_proposal': {
      const { id, ...updates } = data
      const { error } = await supabase
        .from('proposals')
        .update(updates)
        .eq('id', id)
      if (error) throw error
      break
    }

    case 'insert_funder': {
      const { error } = await supabase
        .from('funders')
        .insert(data.funder)
      if (error) throw error
      break
    }

    case 'update_funder': {
      const { id, ...updates } = data
      const { error } = await supabase
        .from('funders')
        .update(updates)
        .eq('id', id)
      if (error) throw error
      break
    }
    ```

    IMPORTANT: Use the same auth/validation patterns established in Phase 3:
    - Server actions: `createClient` from `@/lib/supabase/server`, get user, get org_id from profiles
    - Webhook route: `createServiceClient` with service role key, validate webhook secret
    - Fire-and-forget: `fetch().catch(err => console.error(...))`
    - Do NOT await the n8n fetch calls
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors.
    Verify `app/(dashboard)/proposals/actions.ts` exports: getProposals, getProposal, triggerProposalGeneration, triggerQualityReview, triggerFunderAnalysis, updateProposalSection, reorderSections, getFunder.
    Verify `app/api/webhook/route.ts` contains cases for: insert_proposal, insert_proposal_sections, update_proposal, insert_funder, update_funder.
  </verify>
  <done>
    All proposal/funder server actions created with fire-and-forget webhook pattern. Webhook route extended with 5 new action cases for n8n callbacks. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npm ls use-debounce` shows installed version
2. `components/ui/accordion.tsx` and `components/ui/progress.tsx` exist
3. `app/(dashboard)/proposals/actions.ts` exports all 8 server actions
4. `app/api/webhook/route.ts` handles 10+ action types (5 existing + 5 new)
5. `npx tsc --noEmit` passes with zero errors
</verification>

<success_criteria>
- use-debounce installed and importable
- shadcn accordion and progress components available
- All server actions follow established patterns (auth check, org_id lookup, fire-and-forget)
- Webhook route handles all n8n callback actions for proposals and funders
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-eligibility-screening-proposal-generation/04-01-SUMMARY.md`
</output>
