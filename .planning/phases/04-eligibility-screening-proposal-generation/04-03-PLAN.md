---
phase: 04-eligibility-screening-proposal-generation
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/(dashboard)/proposals/[id]/page.tsx
  - app/(dashboard)/proposals/[id]/components/proposal-detail-client.tsx
  - app/(dashboard)/proposals/[id]/components/proposal-sections.tsx
  - app/(dashboard)/proposals/[id]/components/section-editor.tsx
  - app/(dashboard)/proposals/[id]/components/quality-review.tsx
  - app/(dashboard)/proposals/[id]/components/funder-analysis.tsx
autonomous: true

must_haves:
  truths:
    - "User can view AI-generated proposal content organized by expandable sections"
    - "User can edit proposal section content inline with rich text formatting"
    - "User edits are autosaved with debounce (no explicit save button needed)"
    - "User can reorder sections with up/down buttons"
    - "User can trigger AI quality review and see scores, issues, and rewrite suggestions"
    - "User sees funder profile with giving patterns, priorities, and ProPublica 990 data"
  artifacts:
    - path: "app/(dashboard)/proposals/[id]/page.tsx"
      provides: "Server component fetching proposal, sections, grant, and funder data"
    - path: "app/(dashboard)/proposals/[id]/components/proposal-sections.tsx"
      provides: "Accordion-based section list with section editors and reorder buttons"
    - path: "app/(dashboard)/proposals/[id]/components/section-editor.tsx"
      provides: "Tiptap inline editor with debounced autosave"
      contains: "useDebouncedCallback"
    - path: "app/(dashboard)/proposals/[id]/components/quality-review.tsx"
      provides: "Quality score display, issues list, rewrite suggestions, trigger button"
    - path: "app/(dashboard)/proposals/[id]/components/funder-analysis.tsx"
      provides: "Funder strategy brief, giving patterns, 990 data display"
  key_links:
    - from: "app/(dashboard)/proposals/[id]/components/section-editor.tsx"
      to: "app/(dashboard)/proposals/actions.ts"
      via: "updateProposalSection server action called from debounced callback"
      pattern: "useDebouncedCallback.*updateProposalSection"
    - from: "app/(dashboard)/proposals/[id]/components/quality-review.tsx"
      to: "app/(dashboard)/proposals/actions.ts"
      via: "triggerQualityReview server action"
      pattern: "triggerQualityReview"
    - from: "app/(dashboard)/proposals/[id]/components/proposal-sections.tsx"
      to: "app/(dashboard)/proposals/actions.ts"
      via: "reorderSections server action"
      pattern: "reorderSections"
---

<objective>
Build the proposal detail page with accordion-based sections, inline Tiptap editing with debounced autosave, quality review display with trigger button, and funder analysis display.

Purpose: This is the core editing experience where users view, edit, and improve AI-generated proposals. Inline editing with autosave eliminates friction. Quality review gives actionable feedback. Funder analysis provides strategic context.
Output: Complete proposal detail page with sections, editor, quality review, and funder analysis panels.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-eligibility-screening-proposal-generation/04-RESEARCH.md
@.planning/phases/04-eligibility-screening-proposal-generation/04-01-SUMMARY.md
@app/(dashboard)/proposals/actions.ts
@app/(dashboard)/narratives/components/narrative-editor.tsx
@app/(dashboard)/pipeline/[id]/page.tsx
@lib/supabase/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build proposal detail page with accordion sections and Tiptap inline editor</name>
  <files>
    app/(dashboard)/proposals/[id]/page.tsx
    app/(dashboard)/proposals/[id]/components/proposal-detail-client.tsx
    app/(dashboard)/proposals/[id]/components/proposal-sections.tsx
    app/(dashboard)/proposals/[id]/components/section-editor.tsx
  </files>
  <action>
    **Create `app/(dashboard)/proposals/[id]/page.tsx`** as a server component:
    - Accept `params: Promise<{ id: string }>` (Next.js 16 async params pattern, same as pipeline/[id]/page.tsx)
    - Call `getProposal(id)` from `../../actions`
    - If not found, call `notFound()` from next/navigation
    - Also fetch funder data if grant has a funder_name: query `funders` table where org_id matches and name matches grant.funder_name
    - Pass proposal, sections, grant, and funder to a client wrapper component

    **Create `app/(dashboard)/proposals/[id]/components/proposal-detail-client.tsx`** as the client wrapper:
    - Props: `{ proposal, sections, grant, funder }`
    - Layout with two columns on large screens (lg:grid-cols-3):
      - Left column (col-span-2): Proposal header (title, status badge, grant name) + ProposalSections
      - Right column (col-span-1): Quality review panel + Funder analysis panel
    - Back button linking to `/proposals` (same pattern as grant-detail.tsx)
    - Show proposal title as h1, status badge, grant title as subtitle
    - Set up Supabase Realtime subscription on `proposals` table filtered by `id=eq.${proposal.id}` for UPDATE events:
      - When quality_score or quality_review changes, update local state to show new review results
      - Cleanup channel on unmount
    - Also subscribe to `proposal_sections` table for changes (INSERT/UPDATE) to refresh sections when n8n inserts them

    **Create `app/(dashboard)/proposals/[id]/components/proposal-sections.tsx`**:
    - Props: `{ sections: Section[], onSectionsChange?: (sections: Section[]) => void }`
    - Use shadcn Accordion with `type="multiple"` and `defaultValue` set to all section IDs (all expanded by default)
    - Sort sections by `sort_order` before rendering
    - Each AccordionItem:
      - AccordionTrigger: section title + up/down reorder buttons on the right
      - AccordionContent: SectionEditor component
    - Reorder buttons (ChevronUp / ChevronDown from lucide-react):
      - Up button disabled on first section
      - Down button disabled on last section
      - On click: swap sort_order values between adjacent sections, call `reorderSections()` server action with the updated `[{ id, sort_order }]` array
      - Use `e.stopPropagation()` on button clicks to prevent accordion toggle
    - Empty state: "No sections yet. Proposal sections will appear here after generation completes."

    **Create `app/(dashboard)/proposals/[id]/components/section-editor.tsx`**:
    - Props: `{ sectionId: string, initialContent: string }`
    - Use Tiptap editor with the EXACT same configuration as narrative-editor.tsx:
      - `immediatelyRender: false` (critical for Next.js hydration)
      - Extensions: `StarterKit`, `Placeholder.configure({ placeholder: 'Section content...' })`
      - `content: initialContent`
      - `editable: true`
    - Add toolbar matching narrative-editor.tsx: Bold, Italic, H2, BulletList, OrderedList, Blockquote
    - Use `useDebouncedCallback` from `use-debounce` package for autosave:
      ```typescript
      const debouncedSave = useDebouncedCallback(
        async (html: string) => {
          setSaving(true)
          await updateProposalSection(sectionId, html)
          setSaving(false)
        },
        2000 // 2 second debounce
      )
      ```
    - Wire `onUpdate` to debounced save:
      ```typescript
      onUpdate: ({ editor }) => {
        debouncedSave(editor.getHTML())
      }
      ```
    - Show "Saving..." indicator when save is in progress (small text below editor, text-muted-foreground)
    - Show "Saved" briefly after save completes (fade after 2 seconds)
    - Wrap editor in `div.border.rounded-md.p-4` with `prose prose-sm max-w-none` on EditorContent

    IMPORTANT: Follow Tiptap patterns from Phase 3 narrative-editor.tsx exactly:
    - `'use client'` directive
    - `useEditor` hook with `immediatelyRender: false`
    - Return null if `!editor`
    - Toolbar buttons use `editor.chain().focus().toggleBold().run()` pattern
    - Active state: `editor.isActive('bold')` for button highlighting
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors.
    Verify section-editor.tsx imports `useDebouncedCallback` from 'use-debounce'.
    Verify section-editor.tsx uses `immediatelyRender: false` in useEditor.
    Verify proposal-sections.tsx uses shadcn Accordion with type="multiple".
    Verify proposal detail page.tsx uses async params pattern.
  </verify>
  <done>
    Proposal detail page displays sections in expandable accordion. Each section has a Tiptap rich text editor with toolbar matching the narrative editor. Edits are autosaved with 2-second debounce. Sections can be reordered with up/down buttons. Realtime subscription updates sections when n8n inserts new ones.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build quality review display and funder analysis panels</name>
  <files>
    app/(dashboard)/proposals/[id]/components/quality-review.tsx
    app/(dashboard)/proposals/[id]/components/funder-analysis.tsx
  </files>
  <action>
    **Create `app/(dashboard)/proposals/[id]/components/quality-review.tsx`**:
    - Props: `{ proposalId: string, qualityScore: number | null, qualityReview: QualityReviewData | null }`
    - Define TypeScript interface for quality review data (stored as jsonb in proposals.quality_review):
      ```typescript
      interface QualityReviewData {
        overall_score: number
        section_scores?: Array<{ section: string; score: number; feedback: string }>
        issues: Array<{
          type: 'jargon' | 'passive_voice' | 'vagueness' | 'alignment' | 'completeness' | 'formatting'
          severity: 'low' | 'medium' | 'high'
          text: string
          suggestion: string
          section?: string
        }>
        summary?: string
      }
      ```
    - Layout:
      - Card header: "Quality Review" with a "Run Review" button (ClipboardCheck icon)
      - If no review: show "No quality review yet. Click 'Run Review' to analyze this proposal." with Run Review button
      - If review exists:
        - Overall score display: large number with color coding (green >=80, yellow >=60, red <60)
        - Summary text if available
        - Section scores: small cards with section name + score
        - Issues list: each issue in a left-bordered card (border color by severity: high=red, medium=yellow, low=gray):
          - Badge for issue type (format: replace underscores with spaces, capitalize)
          - Badge for severity (destructive for high, secondary for medium/low)
          - "Found:" text showing the problematic text
          - "Suggestion:" text showing the rewrite suggestion
    - "Run Review" button:
      - On click: call `triggerQualityReview(proposalId)` server action
      - Show loading state while server action responds
      - After trigger: show WorkflowProgress component (import from pipeline components or create shared version)
      - When workflow completes (via Realtime subscription on proposals table), the parent component updates qualityReview prop

    **Create `app/(dashboard)/proposals/[id]/components/funder-analysis.tsx`**:
    - Props: `{ grantId: string, funderName: string | null, funder: FunderData | null }`
    - Define TypeScript interface matching funders table structure:
      ```typescript
      interface FunderData {
        id: string
        name: string
        ein: string | null
        strategy_brief: string | null
        giving_patterns: {
          focus_areas?: string[]
          avg_grant_size?: number
          total_giving?: number
          geographic_focus?: string[]
        } | null
        priorities: {
          current?: string[]
          emerging?: string[]
        } | null
        submission_preferences: {
          format?: string
          timeline?: string
          contact?: string
          tips?: string[]
        } | null
        propublica_data: {
          name?: string
          ein?: string
          revenue?: number
          assets?: number
          ntee_code?: string
          filings?: Array<{
            tax_period: string
            totrevenue: number
            totfuncexpns: number
          }>
        } | null
      }
      ```
    - Layout using Cards:
      - If no funder and no funderName: "No funder information available for this grant."
      - If funderName but no funder data: show funderName with "Analyze Funder" button to trigger analysis
        - On click: call `triggerFunderAnalysis(grantId, funderName)` server action
        - Show WorkflowProgress after trigger
      - If funder data exists, display in organized cards:
        1. **Funder Header Card**: Name, EIN (if available)
        2. **Strategy Brief Card**: Full text of strategy_brief (if available)
        3. **Giving Patterns Card**: Focus areas as badges, average grant size formatted as currency, total giving, geographic focus
        4. **Priorities Card**: Current priorities as list, emerging priorities as list
        5. **Submission Preferences Card**: Format, timeline, contact info, tips as bullet list
        6. **ProPublica 990 Data Card** (if propublica_data exists):
           - Organization name from 990
           - Revenue formatted as currency
           - Assets formatted as currency
           - NTEE code (if available)
           - Filing history: small table or list showing tax_period + revenue for each filing year

    Format currency values with `toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 })`.

    Use consistent card styling: Card with CardHeader + CardTitle + CardContent. Use Separator between logical sections. Use Badge for tags/categories. Use text-muted-foreground for secondary text.

    IMPORTANT: Both components are 'use client' components. Import server actions from `@/app/(dashboard)/proposals/actions`. The WorkflowProgress component from plan 04-02 should be importable. If not feasible due to file structure, create a minimal inline version following the same Realtime subscription pattern.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors.
    Verify quality-review.tsx has "Run Review" button calling triggerQualityReview.
    Verify quality-review.tsx displays score with color coding and issues with severity badges.
    Verify funder-analysis.tsx displays strategy brief, giving patterns, priorities, submission preferences, and 990 data.
    Verify funder-analysis.tsx has "Analyze Funder" button calling triggerFunderAnalysis.
  </verify>
  <done>
    Quality review panel shows overall score, section scores, and issues with severity and rewrite suggestions. Users can trigger quality review with one click. Funder analysis panel shows strategy brief, giving patterns, priorities, submission preferences, and ProPublica 990 financial data. Users can trigger funder analysis with one click. Both panels update via Realtime when n8n completes the workflow.
  </done>
</task>

</tasks>

<verification>
1. Navigate to `/proposals/{id}` to see proposal detail with accordion sections
2. Each section has a Tiptap editor with toolbar (Bold, Italic, H2, Lists, Blockquote)
3. Editing a section triggers debounced autosave (check network tab for 2s delay)
4. Up/down buttons reorder sections
5. Quality review panel shows score and issues (or empty state with trigger button)
6. Funder analysis panel shows strategy brief and 990 data (or empty state with trigger button)
7. `npx tsc --noEmit` passes with zero errors
</verification>

<success_criteria>
- Proposal sections render in accordion with expand/collapse
- Tiptap editor per section with matching toolbar and debounced autosave
- Section reordering with up/down buttons
- Quality review: score display, issues list, trigger button
- Funder analysis: strategy brief, 990 data, giving patterns, trigger button
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-eligibility-screening-proposal-generation/04-03-SUMMARY.md`
</output>
