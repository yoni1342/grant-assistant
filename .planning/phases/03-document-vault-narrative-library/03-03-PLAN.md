---
phase: 03-document-vault-narrative-library
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/(dashboard)/narratives/page.tsx
  - app/(dashboard)/narratives/actions.ts
  - app/(dashboard)/narratives/components/narrative-list.tsx
  - app/(dashboard)/narratives/components/narrative-editor.tsx
  - app/(dashboard)/narratives/components/narrative-dialog.tsx
  - app/(dashboard)/narratives/components/ai-customize-button.tsx
autonomous: true

must_haves:
  truths:
    - "User can browse existing narrative blocks in a searchable, filterable list"
    - "User can create a new narrative block with title, category, tags, and rich text content"
    - "User can edit an existing narrative block (title, category, tags, content)"
    - "User can search narratives by title text"
    - "User can filter narratives by category (mission, impact, methods, evaluation, sustainability, capacity, budget_narrative, other)"
    - "User can trigger AI customization of a narrative for a specific grant/funder via n8n webhook"
    - "Tiptap rich text editor renders correctly without hydration errors"
  artifacts:
    - path: "app/(dashboard)/narratives/page.tsx"
      provides: "Narrative library server component page"
      contains: "getNarratives"
    - path: "app/(dashboard)/narratives/actions.ts"
      provides: "Narrative CRUD server actions + AI customization trigger"
      contains: "'use server'"
    - path: "app/(dashboard)/narratives/components/narrative-list.tsx"
      provides: "Client-side narrative card list with search and category filter"
      contains: "useState"
    - path: "app/(dashboard)/narratives/components/narrative-editor.tsx"
      provides: "Tiptap rich text editor wrapper"
      contains: "useEditor"
    - path: "app/(dashboard)/narratives/components/narrative-dialog.tsx"
      provides: "Create/edit narrative dialog with form"
      contains: "Dialog"
    - path: "app/(dashboard)/narratives/components/ai-customize-button.tsx"
      provides: "AI customization trigger for a specific narrative"
      contains: "customize-narrative"
  key_links:
    - from: "app/(dashboard)/narratives/page.tsx"
      to: "app/(dashboard)/narratives/actions.ts"
      via: "server action import for initial data fetch"
      pattern: "import.*from.*actions"
    - from: "app/(dashboard)/narratives/components/narrative-dialog.tsx"
      to: "app/(dashboard)/narratives/actions.ts"
      via: "createNarrative and updateNarrative server actions"
      pattern: "(createNarrative|updateNarrative)"
    - from: "app/(dashboard)/narratives/components/narrative-dialog.tsx"
      to: "app/(dashboard)/narratives/components/narrative-editor.tsx"
      via: "Tiptap editor for content input"
      pattern: "NarrativeEditor"
    - from: "app/(dashboard)/narratives/components/ai-customize-button.tsx"
      to: "app/(dashboard)/narratives/actions.ts"
      via: "triggerAICustomization server action"
      pattern: "triggerAICustomization"
    - from: "app/(dashboard)/narratives/actions.ts"
      to: "N8N_WEBHOOK_URL/customize-narrative"
      via: "fetch to n8n webhook"
      pattern: "customize-narrative"
---

<objective>
Build the complete Narrative Library: CRUD server actions, a browsable card list with search/filter by category, a Tiptap rich text editor for creating/editing narratives, and an AI customization trigger that fires n8n webhooks.

Purpose: This is the user-facing Narrative Library satisfying requirements NARR-01 through NARR-05. Users need to create, browse, edit, search, filter, and AI-customize narrative blocks used in grant proposals.
Output: Fully functional /narratives page replacing the placeholder stub.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-document-vault-narrative-library/03-RESEARCH.md
@.planning/phases/03-document-vault-narrative-library/03-01-SUMMARY.md
@lib/supabase/client.ts
@lib/supabase/server.ts
@lib/supabase/database.types.ts
@app/(dashboard)/layout.tsx
@components/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create narrative server actions and narrative list page with search/filter</name>
  <files>
    app/(dashboard)/narratives/actions.ts
    app/(dashboard)/narratives/page.tsx
    app/(dashboard)/narratives/components/narrative-list.tsx
  </files>
  <action>
**Step A: Create narrative server actions**

Create `app/(dashboard)/narratives/actions.ts`:

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
```

Implement these server actions:

1. **`getNarratives()`**: Query `narratives` table, `SELECT *`, ordered by `updated_at DESC`. Returns `{ data: Narrative[], error: string | null }`. RLS handles org scoping.

2. **`createNarrative(formData: FormData)`**:
   - Extract fields: `title` (string, required), `content` (string, required — HTML from Tiptap), `category` (narrative_category enum value or null), `tags` (comma-separated string, split into string array and trim each tag).
   - Get authenticated user and their `org_id` from profiles (same pattern as documents/actions.ts).
   - Insert into `narratives` table with `org_id`, `title`, `content`, `category`, `tags`.
   - `revalidatePath('/narratives')`.
   - Return `{ data: narrative, error: null }` on success, `{ error: message }` on failure.

3. **`updateNarrative(narrativeId: string, formData: FormData)`**:
   - Extract same fields as create.
   - Update the narrative by ID.
   - `revalidatePath('/narratives')`.
   - Return `{ data: narrative, error: null }` on success.

4. **`deleteNarrative(narrativeId: string)`**:
   - Delete narrative by ID from `narratives` table.
   - `revalidatePath('/narratives')`.
   - Return `{ success: true }` or `{ error: message }`.

5. **`triggerAICustomization(narrativeId: string, grantId: string)`**:
   - Fire-and-forget POST to `${process.env.N8N_WEBHOOK_URL}/customize-narrative` with `{ narrative_id: narrativeId, grant_id: grantId }`.
   - Include `X-Webhook-Secret` header.
   - Don't await the fetch — use `.catch()` for error logging.
   - Return `{ success: true }` immediately.
   - This webhook tells n8n to customize the narrative content for a specific grant/funder using AI. n8n will update the narrative directly in Supabase when done.

**Step B: Create the narrative list component**

Create `app/(dashboard)/narratives/components/narrative-list.tsx`:

Client component (`'use client'`) that renders narratives as cards (not a table — narratives are content blocks, better displayed as cards):

Props: `initialData: Narrative[]` (from page server component), `grants: Grant[]` (for AI customization dropdown — list of grants to customize for).

State:
- `narratives`: initialized from `initialData`
- `searchQuery`: string for filtering by title
- `categoryFilter`: string (narrative_category value or 'all')

UI layout:
- **Header row**: Search input (left) + Category filter dropdown (right)
- **Category filter**: shadcn `Select` with options: "All Categories", "Mission", "Impact", "Methods", "Evaluation", "Sustainability", "Capacity", "Budget Narrative", "Other". Values map to enum: `mission`, `impact`, `methods`, `evaluation`, `sustainability`, `capacity`, `budget_narrative`, `other`.
- **Grid**: `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4` for card layout.
- **Card**: shadcn `Card` with:
  - `CardHeader`: Title (truncated to 1 line) + category badge (shadcn `Badge`, color varies by category)
  - `CardContent`: Content preview — strip HTML tags and truncate to 150 characters. Show as `text-sm text-muted-foreground`.
  - `CardFooter`: "Updated X ago" timestamp + row of action buttons:
    - Edit button (pencil icon) — opens NarrativeDialog in edit mode (will be implemented in Task 2)
    - AI Customize button (sparkles icon) — opens AI customization flow (Task 2)
    - Delete button (trash icon) — calls deleteNarrative with confirmation
  - Tags display: If tags exist, show as small badges below content preview.
- **Empty state**: "No narratives yet. Create your first narrative block to get started." with a "Create Narrative" button.
- **Empty filter state**: "No narratives match your search."

Filtering logic (client-side):
- Filter `narratives` by `searchQuery` (case-insensitive `title.includes(query)`)
- Filter by `categoryFilter` if not 'all' (match `category` field)
- Both filters applied simultaneously

Add Realtime subscription (same pattern as document table):
- Subscribe to `postgres_changes` on `narratives` table for INSERT, UPDATE, DELETE events.
- INSERT: prepend to narratives array
- UPDATE: replace matching narrative by ID (AI customization results appear here)
- DELETE: remove from array
- Cleanup: remove channel on unmount

**Step C: Replace the narratives page stub**

Replace `app/(dashboard)/narratives/page.tsx` (currently placeholder):

Server component that:
1. Calls `getNarratives()` to fetch initial data.
2. Also fetches grants list for the AI customization dropdown: query `grants` table, `SELECT id, title` ordered by `title ASC` (just enough for a dropdown picker).
3. Renders page header: "Narratives" title + subtitle "Reusable content blocks for grant proposals" + "New Narrative" button (opens dialog from Task 2).
4. Passes data to `<NarrativeList initialData={narratives} grants={grants} />`.
5. Follow the same design pattern as the documents page (p-6 padding, consistent heading style).
  </action>
  <verify>
1. Run `npm run build` to confirm no TypeScript errors.
2. Verify `app/(dashboard)/narratives/actions.ts` exists with `'use server'` directive and exports: getNarratives, createNarrative, updateNarrative, deleteNarrative, triggerAICustomization.
3. Verify `app/(dashboard)/narratives/components/narrative-list.tsx` exists and imports from `@/lib/supabase/client` for Realtime.
4. Verify `app/(dashboard)/narratives/page.tsx` calls getNarratives and renders NarrativeList.
5. Verify category filter has all 8 narrative_category enum values as options.
  </verify>
  <done>Narrative server actions provide full CRUD (create, read, update, delete) plus AI customization webhook trigger. Narrative list page displays narratives as cards in a responsive grid with search by title and filter by category. Realtime subscription updates cards when narratives are created, updated, or deleted. Page replaces the Phase 3 placeholder stub.</done>
</task>

<task type="auto">
  <name>Task 2: Build Tiptap editor, create/edit dialog, and AI customization trigger</name>
  <files>
    app/(dashboard)/narratives/components/narrative-editor.tsx
    app/(dashboard)/narratives/components/narrative-dialog.tsx
    app/(dashboard)/narratives/components/ai-customize-button.tsx
  </files>
  <action>
**Step A: Create the Tiptap rich text editor component**

Create `app/(dashboard)/narratives/components/narrative-editor.tsx`:

Client component (`'use client'`) wrapping Tiptap:

```typescript
'use client'

import { useEditor, EditorContent } from '@tiptap/react'
import StarterKit from '@tiptap/starter-kit'
import Placeholder from '@tiptap/extension-placeholder'
```

Props:
- `content: string` — initial HTML content
- `onUpdate: (html: string) => void` — callback when content changes
- `placeholder?: string` — placeholder text (default: "Start writing your narrative...")
- `editable?: boolean` — whether editor is editable (default: true)

Implementation:
- `useEditor` with `immediatelyRender: false` (CRITICAL: prevents Next.js hydration mismatch).
- Extensions: `StarterKit` (includes bold, italic, headings, lists, blockquote, code, etc.) + `Placeholder`.
- `onUpdate` callback extracts HTML via `editor.getHTML()`.
- Return `null` if editor is not ready (loading state).

Toolbar: A simple, clean toolbar row above the editor content with icon buttons:
- **Bold** (Bold icon from lucide-react)
- **Italic** (Italic icon)
- **Heading 2** (Heading2 icon) — toggles H2
- **Bullet List** (List icon)
- **Ordered List** (ListOrdered icon)
- **Blockquote** (Quote icon)

Each button:
- Uses `editor.chain().focus().toggleBold().run()` pattern
- Shows active state with `bg-zinc-200 dark:bg-zinc-700` when `editor.isActive('bold')` etc.
- Styled as small icon buttons: `p-1.5 rounded-md hover:bg-zinc-100 dark:hover:bg-zinc-800`

Editor content area:
- Wrapped in `div` with `border rounded-md` (toolbar top, content below)
- Editor content has `prose prose-sm max-w-none p-4` classes for clean typography
- Min height: `min-h-[200px]` so editor doesn't collapse when empty

Styling note: Add basic Tiptap/ProseMirror CSS for the editor. Add a `.tiptap` class style in the component or a scoped style block:
- `.ProseMirror:focus { outline: none; }` — remove default focus outline
- `.ProseMirror p.is-editor-empty:first-child::before { ... }` — placeholder styling (gray, italic)

Use Tailwind `@apply` in a small style block or inline the styles. Keep it minimal — the Tiptap placeholder extension handles the placeholder text, just ensure it's styled subtly.

**Step B: Create the narrative create/edit dialog**

Create `app/(dashboard)/narratives/components/narrative-dialog.tsx`:

Client component using shadcn `Dialog`:

Props:
- `mode: 'create' | 'edit'`
- `narrative?: Narrative` — existing narrative data (required for edit mode)
- `open: boolean`
- `onOpenChange: (open: boolean) => void`

Form fields:
1. **Title**: shadcn `Input`, required, placeholder "e.g., Organization Mission Statement"
2. **Category**: shadcn `Select` with all 8 narrative_category enum options. Optional (nullable).
3. **Tags**: shadcn `Input`, placeholder "e.g., education, youth, STEM (comma-separated)". Stored as comma-separated, split on save.
4. **Content**: `<NarrativeEditor />` component. Pass `content` and `onUpdate` to track the HTML content in local state.

State management:
- Use `useState` for each field (title, category, tags string, content HTML)
- In edit mode, initialize from `narrative` prop
- Use `useTransition` for pending state on save

Submit handling:
- Build `FormData` manually: `formData.set('title', title)`, `formData.set('content', content)`, etc.
- Create mode: call `createNarrative(formData)` server action
- Edit mode: call `updateNarrative(narrative.id, formData)` server action
- On success: close dialog
- On error: show error message inline (do not close dialog)

Dialog layout:
- `DialogHeader`: Title "Create Narrative" or "Edit Narrative"
- `DialogContent`: Form fields stacked vertically with proper spacing (space-y-4)
- `DialogFooter`: Cancel button + Save button with loading state
- Dialog should be wide enough for the editor: `className="sm:max-w-[700px]"`

**Step C: Wire the dialog into the narrative list and page**

Update `narrative-list.tsx` to:
- Import `NarrativeDialog`
- Add state for dialog: `dialogOpen`, `dialogMode`, `selectedNarrative`
- Edit button on each card opens dialog in edit mode with that narrative's data
- The page's "New Narrative" button opens dialog in create mode (pass an `onCreateClick` callback from list, or use a portal trigger)

Update `page.tsx` to pass the dialog trigger. The simplest approach: render `NarrativeDialog` inside `NarrativeList` component and manage open/close state there.

**Step D: Create the AI customization button**

Create `app/(dashboard)/narratives/components/ai-customize-button.tsx`:

Client component (`'use client'`):

Props:
- `narrativeId: string`
- `grants: { id: string; title: string }[]` — available grants to customize for

UI:
- Button with sparkles icon (lucide-react `Sparkles`)
- On click: opens a small popover (shadcn `Popover`) or dropdown with a grant picker
- Grant picker: shadcn `Select` showing available grants by title
- "Customize" confirm button in the popover
- Loading state: button shows spinner/disabled while triggering
- Calls `triggerAICustomization(narrativeId, selectedGrantId)` server action
- On success: show subtle feedback "AI customization started" (the actual update arrives via Realtime when n8n finishes)
- On error: show error message

Keep it simple — this is a fire-and-forget trigger. The n8n webhook does the heavy lifting. The UI just needs to tell the user it was triggered.
  </action>
  <verify>
1. Run `npm run build` to confirm no TypeScript errors.
2. Verify `narrative-editor.tsx` imports from `@tiptap/react` and sets `immediatelyRender: false`.
3. Verify `narrative-dialog.tsx` renders NarrativeEditor and calls createNarrative/updateNarrative server actions.
4. Verify `ai-customize-button.tsx` calls triggerAICustomization with narrative and grant IDs.
5. Verify the dialog renders in both create and edit modes correctly.
6. Verify toolbar has bold, italic, heading, bullet list, ordered list, and blockquote buttons.
  </verify>
  <done>Tiptap rich text editor renders with toolbar (bold, italic, heading, lists, blockquote) and no hydration errors. Create/edit dialog allows users to set title, category, tags, and rich text content. AI customization button opens a grant picker popover and fires n8n webhook. All three components are wired into the narrative list page.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Navigate to /narratives — page shows card grid (empty state if no narratives exist)
3. "New Narrative" button opens create dialog with Tiptap editor
4. Creating a narrative adds it to the grid (via Realtime or revalidation)
5. Edit button on card opens dialog pre-filled with narrative data
6. Rich text editing works: bold, italic, headings, lists render correctly
7. Category filter dropdown filters cards by category
8. Search input filters cards by title
9. Delete button removes narrative with confirmation
10. AI Customize button shows grant picker and triggers n8n webhook
</verification>

<success_criteria>
- /narratives page replaces placeholder with card grid layout
- Narratives display title, category badge, content preview, tags, and update timestamp
- Create dialog with Tiptap editor allows rich text content authoring
- Edit dialog pre-fills all fields and saves changes
- Search by title works with case-insensitive matching
- Filter by category works with all 8 narrative categories
- Delete with confirmation removes narrative from database and UI
- AI customization trigger fires n8n webhook with narrative_id and grant_id
- Tiptap editor renders without hydration errors (immediatelyRender: false)
- Realtime subscription updates narrative cards when data changes
</success_criteria>

<output>
After completion, create `.planning/phases/03-document-vault-narrative-library/03-03-SUMMARY.md`
</output>
