---
phase: 03-document-vault-narrative-library
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/(dashboard)/documents/page.tsx
  - app/(dashboard)/documents/components/columns.tsx
  - app/(dashboard)/documents/components/document-table.tsx
  - app/(dashboard)/documents/components/upload-dialog.tsx
  - app/(dashboard)/documents/components/document-row-actions.tsx
  - app/api/webhook/route.ts
autonomous: true

must_haves:
  truths:
    - "User can browse document vault with a searchable, filterable data table"
    - "User can upload documents via a dialog with file type/size validation feedback"
    - "User can filter documents by file type using a dropdown"
    - "User can see document metadata: name, type, category, size, upload date"
    - "User can delete documents via row action menu"
    - "User can download documents via signed URL"
    - "AI categorization status updates appear in real-time without page refresh"
    - "n8n can POST categorization results back via webhook and documents table updates"
  artifacts:
    - path: "app/(dashboard)/documents/page.tsx"
      provides: "Document vault server component page"
      contains: "getDocuments"
    - path: "app/(dashboard)/documents/components/document-table.tsx"
      provides: "Client-side data table with search, filter, and Realtime subscription"
      contains: "useReactTable"
    - path: "app/(dashboard)/documents/components/columns.tsx"
      provides: "TanStack Table column definitions for documents"
      contains: "ColumnDef"
    - path: "app/(dashboard)/documents/components/upload-dialog.tsx"
      provides: "File upload dialog with validation"
      contains: "uploadDocument"
    - path: "app/(dashboard)/documents/components/document-row-actions.tsx"
      provides: "Row action dropdown (download, delete)"
      contains: "deleteDocument"
    - path: "app/api/webhook/route.ts"
      provides: "Extended webhook handler with update_document action"
      contains: "update_document"
  key_links:
    - from: "app/(dashboard)/documents/page.tsx"
      to: "app/(dashboard)/documents/actions.ts"
      via: "server action import for initial data fetch"
      pattern: "import.*from.*actions"
    - from: "app/(dashboard)/documents/components/document-table.tsx"
      to: "@supabase/supabase-js"
      via: "Realtime subscription for document updates"
      pattern: "channel.*postgres_changes.*documents"
    - from: "app/(dashboard)/documents/components/upload-dialog.tsx"
      to: "app/(dashboard)/documents/actions.ts"
      via: "uploadDocument server action"
      pattern: "uploadDocument"
    - from: "app/(dashboard)/documents/components/document-row-actions.tsx"
      to: "app/(dashboard)/documents/actions.ts"
      via: "deleteDocument server action"
      pattern: "deleteDocument"
    - from: "app/api/webhook/route.ts"
      to: "supabase.from('documents')"
      via: "update_document webhook action"
      pattern: "update_document"
---

<objective>
Build the complete Document Vault UI: a data table with search/filter, upload dialog, row actions (download/delete), and real-time AI categorization updates via Supabase Realtime and n8n webhook integration.

Purpose: This is the user-facing Document Vault that satisfies requirements DOCS-01 through DOCS-05. Users need to upload, browse, search, filter, view metadata, and delete documents from a single page.
Output: Fully functional /documents page replacing the placeholder stub.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-document-vault-narrative-library/03-RESEARCH.md
@.planning/phases/03-document-vault-narrative-library/03-01-SUMMARY.md
@lib/supabase/client.ts
@lib/supabase/server.ts
@lib/supabase/database.types.ts
@lib/supabase/storage.ts
@app/(dashboard)/documents/actions.ts
@app/(dashboard)/layout.tsx
@app/api/webhook/route.ts
@components/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build document vault page with data table, search, filter, and row actions</name>
  <files>
    app/(dashboard)/documents/page.tsx
    app/(dashboard)/documents/components/columns.tsx
    app/(dashboard)/documents/components/document-table.tsx
    app/(dashboard)/documents/components/document-row-actions.tsx
    app/(dashboard)/documents/components/upload-dialog.tsx
  </files>
  <action>
**Step A: Create column definitions**

Create `app/(dashboard)/documents/components/columns.tsx`:

Define TanStack Table columns for the documents table:
- **Name**: Shows file type icon (use lucide-react icons: FileText for PDF, FileSpreadsheet for XLSX, FileImage for images, File for DOCX) + file name. Sortable. Use case-insensitive `includesString` filter.
- **Type**: Short human-readable label derived from MIME type (e.g., "PDF", "Word", "Excel", "PNG", "JPEG"). Filterable via faceted filter.
- **Category**: Show `ai_category || category || "Uncategorized"`. When ai_category is null and document was recently uploaded (< 5 min), show a subtle "Categorizing..." text with muted color to indicate n8n is processing.
- **Size**: Human-readable file size (e.g., "2.4 MB", "156 KB"). Use a simple helper function: `formatFileSize(bytes)`.
- **Uploaded**: Relative time using `formatDistanceToNow` from date-fns (e.g., "2 hours ago"). Install date-fns if not already present (check package.json first - it may not be installed yet; if not, `npm install date-fns`).
- **Actions**: Render `<DocumentRowActions />` component.

Export a `Document` type matching the `documents` table Row type from database.types.ts. Also export a `formatFileSize` helper and a `getFileTypeLabel` helper.

**Step B: Create row actions dropdown**

Create `app/(dashboard)/documents/components/document-row-actions.tsx`:

Client component (`'use client'`) with a shadcn `DropdownMenu`:
- "Download" action: calls `getDocumentSignedUrl` server action (create a thin wrapper server action in `actions.ts` if needed), opens URL in new tab via `window.open()`.
- "Delete" action: shows confirmation via `window.confirm()`, then calls `deleteDocument` server action. On success, the table refreshes via Realtime or revalidation.

Use lucide-react icons: `Download`, `Trash2`, `MoreHorizontal` for the trigger button.

**Step C: Create upload dialog**

Create `app/(dashboard)/documents/components/upload-dialog.tsx`:

Client component using shadcn `Dialog`:
- File input accepting `.pdf,.docx,.xlsx,.png,.jpg,.jpeg`
- Client-side validation: check file type and size (25MB max) before submitting, show inline error message
- Submit button with loading state (disabled + "Uploading..." text during upload)
- Calls `uploadDocument` server action with FormData
- On success: close dialog, optionally show success message
- On error: display error message in dialog (do NOT close)
- Use `useTransition` from React for pending state management since this calls a server action

**Step D: Create the data table component**

Create `app/(dashboard)/documents/components/document-table.tsx`:

Client component using TanStack Table + shadcn Table:
- Props: `initialData: Document[]` (server-fetched documents passed from page)
- State: `documents` (initialized from `initialData`), `columnFilters`, `globalFilter`
- Search: An `Input` component for searching by document name (global filter on 'name' column)
- Type filter: A `Select` component (shadcn) to filter by file type. Options: "All Types", "PDF", "Word", "Excel", "Images". Maps to MIME type values for column filter.
- Table rendering: Use shadcn `Table`, `TableHeader`, `TableBody`, `TableRow`, `TableHead`, `TableCell` components with `flexRender` from TanStack.
- Empty state: "No documents found. Upload your first document to get started." when table is empty.
- Empty filter state: "No documents match your search." when filters return zero results but documents exist.

Include Realtime subscription (see Task 2 for details — build the table shell first, Realtime will be added in Task 2).

**Step E: Replace the documents page stub**

Replace `app/(dashboard)/documents/page.tsx` (currently a placeholder):

Server component that:
1. Calls `getDocuments()` server action to fetch initial document list
2. Renders page header: "Documents" title + subtitle "Manage your organization's document vault" + Upload button (opens upload dialog)
3. Passes fetched documents to `<DocumentTable initialData={documents} />` client component
4. Layout: Clean header row with title on left, upload button on right. Table below with full width.
5. Follow the existing page pattern from the dashboard layout (p-6 padding, text-2xl font-semibold heading).

Use the design aesthetic: clean, minimal (Linear/Notion style). Subtle borders, muted-foreground for secondary text, proper spacing.
  </action>
  <verify>
1. Run `npm run build` to confirm no TypeScript errors.
2. Verify all 5 files exist: page.tsx, columns.tsx, document-table.tsx, document-row-actions.tsx, upload-dialog.tsx.
3. Verify the page imports and renders DocumentTable with initialData prop.
4. Verify columns.tsx exports `columns` array with all required column definitions.
5. Verify upload-dialog.tsx contains file type validation and loading state.
  </verify>
  <done>Document vault page renders a data table with columns for name, type, category, size, and upload date. Search input filters by name. Type dropdown filters by file type. Upload dialog validates file type/size and calls server action. Row actions provide download and delete functionality. Page replaces the Phase 3 placeholder stub.</done>
</task>

<task type="auto">
  <name>Task 2: Wire n8n AI categorization webhook and Realtime subscription for live updates</name>
  <files>
    app/(dashboard)/documents/components/document-table.tsx
    app/api/webhook/route.ts
  </files>
  <action>
**Step A: Add Supabase Realtime subscription to DocumentTable**

Update `app/(dashboard)/documents/components/document-table.tsx` to add a Realtime subscription:

Import `createClient` from `@/lib/supabase/client` (browser client) and `useEffect` from React.

Add a `useEffect` that:
1. Creates a Supabase browser client
2. Subscribes to `postgres_changes` on the `documents` table for `UPDATE` and `INSERT` events
3. On `INSERT`: add the new document to the `documents` state array (at the beginning)
4. On `UPDATE`: find and update the matching document in state (by `payload.new.id`). This is how AI categorization results appear in real-time — n8n updates the `ai_category` field via webhook, which triggers a Postgres change event.
5. On cleanup: remove the channel via `supabase.removeChannel(channel)`

Use this pattern (matches existing Phase 2 Realtime pattern from pipeline):
```typescript
const channel = supabase
  .channel('document-changes')
  .on('postgres_changes',
    { event: 'INSERT', schema: 'public', table: 'documents' },
    (payload) => {
      setDocuments(prev => [payload.new as Document, ...prev])
    }
  )
  .on('postgres_changes',
    { event: 'UPDATE', schema: 'public', table: 'documents' },
    (payload) => {
      setDocuments(prev => prev.map(doc =>
        doc.id === payload.new.id ? (payload.new as Document) : doc
      ))
    }
  )
  .subscribe()
```

Also handle DELETE events to remove documents from state when deleted by another session:
```typescript
.on('postgres_changes',
  { event: 'DELETE', schema: 'public', table: 'documents' },
  (payload) => {
    setDocuments(prev => prev.filter(doc => doc.id !== payload.old.id))
  }
)
```

**Step B: Extend webhook route with update_document action**

Update `app/api/webhook/route.ts` to add a new case in the switch statement:

```typescript
case "update_document": {
  const { id, ...updates } = data;
  const { error } = await supabase
    .from("documents")
    .update(updates)
    .eq("id", id);
  if (error) throw error;
  break;
}
```

This allows n8n to POST back with `{ action: "update_document", data: { id: "doc-uuid", ai_category: "budget" } }` after it finishes categorizing a document. The update triggers a Postgres change event that the Realtime subscription picks up, causing the UI to update without a page refresh.

Follow the exact same pattern as the existing `update_grant` and `update_workflow` cases in the switch statement.
  </action>
  <verify>
1. Run `npm run build` to confirm no TypeScript errors.
2. Verify `app/api/webhook/route.ts` contains `case "update_document"` in the switch block.
3. Verify `document-table.tsx` imports `createClient` from `@/lib/supabase/client` and sets up `channel.on('postgres_changes', ...)`.
4. Verify the Realtime subscription handles INSERT, UPDATE, and DELETE events.
5. Verify the useEffect cleanup function calls `supabase.removeChannel(channel)`.
  </verify>
  <done>Document table subscribes to Supabase Realtime for live INSERT, UPDATE, and DELETE events on the documents table. n8n can POST categorization results via the existing webhook route using the `update_document` action, which triggers a Postgres change event that the UI picks up in real-time. AI categorization status transitions from "Categorizing..." to the actual category without page refresh.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Navigate to /documents — page shows data table (may be empty if no documents exist)
3. Upload dialog opens, validates file type/size, and calls uploadDocument server action
4. After upload, document appears in table (via Realtime INSERT or page revalidation)
5. Type filter dropdown filters documents by file type
6. Search input filters documents by name (case-insensitive)
7. Row actions dropdown shows Download and Delete options
8. Delete action removes document from table and storage
9. Webhook POST to /api/webhook with `{ action: "update_document", data: { id: "...", ai_category: "budget" } }` updates the document's category in real-time
</verification>

<success_criteria>
- /documents page replaces placeholder with full data table
- Documents display name, type, category, size, and relative upload time
- Search by name works with case-insensitive matching
- Filter by file type works via dropdown
- Upload dialog validates file type (PDF, DOCX, XLSX, PNG, JPG) and size (25MB max)
- Row actions provide download (via signed URL) and delete functionality
- Realtime subscription updates table when documents are inserted, updated, or deleted
- Webhook route accepts `update_document` action for n8n categorization results
</success_criteria>

<output>
After completion, create `.planning/phases/03-document-vault-narrative-library/03-02-SUMMARY.md`
</output>
