---
phase: 05-budget-builder-submission-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - components/ui/form.tsx
  - components/ui/checkbox.tsx
  - components/ui/badge.tsx
  - app/(dashboard)/budgets/actions.ts
  - app/(dashboard)/submissions/actions.ts
  - app/api/webhook/route.ts
  - lib/utils/urgency.ts
autonomous: true

must_haves:
  truths:
    - "Server actions exist to create/read/update budgets with line items"
    - "Server actions exist to save and load budget templates using is_template flag"
    - "Server action exists to trigger AI budget narrative generation via n8n fire-and-forget"
    - "Server actions exist to generate/read/update submission checklists with JSONB items"
    - "Server actions exist to log manual submissions and trigger auto-submission"
    - "Webhook route handles insert_budget_narrative and submission_complete actions from n8n"
    - "Urgency calculation utility returns correct levels based on deadline proximity"
    - "react-hook-form, zod, and @hookform/resolvers are installed"
    - "shadcn form, checkbox, and badge components are available"
  artifacts:
    - path: "app/(dashboard)/budgets/actions.ts"
      provides: "All budget server actions (CRUD, templates, narrative trigger)"
      exports: ["getBudgets", "getBudget", "createBudget", "updateBudget", "deleteBudget", "getBudgetTemplates", "saveBudgetAsTemplate", "loadBudgetTemplate", "triggerBudgetNarrative"]
    - path: "app/(dashboard)/submissions/actions.ts"
      provides: "All submission server actions (checklist, submit, history)"
      exports: ["getSubmissionChecklist", "generateChecklist", "updateChecklistItem", "triggerAutoSubmission", "logManualSubmission", "getSubmissions"]
    - path: "app/api/webhook/route.ts"
      provides: "Extended webhook handler for budget narrative and submission completion from n8n"
      contains: "insert_budget_narrative"
    - path: "lib/utils/urgency.ts"
      provides: "Deadline urgency calculation utility"
      exports: ["calculateUrgency", "getUrgencyBadgeVariant", "getUrgencyLabel"]
    - path: "components/ui/form.tsx"
      provides: "shadcn Form component for React Hook Form integration"
    - path: "components/ui/checkbox.tsx"
      provides: "shadcn Checkbox component"
    - path: "components/ui/badge.tsx"
      provides: "shadcn Badge component for urgency indicators"
  key_links:
    - from: "app/(dashboard)/budgets/actions.ts"
      to: "workflow_executions table"
      via: "supabase insert then fire-and-forget fetch to n8n"
      pattern: "workflow_executions.*insert"
    - from: "app/(dashboard)/submissions/actions.ts"
      to: "workflow_executions table"
      via: "supabase insert then fire-and-forget fetch to n8n for auto-submit"
      pattern: "workflow_executions.*insert"
    - from: "app/api/webhook/route.ts"
      to: "budgets table"
      via: "service-role supabase client"
      pattern: "case.*insert_budget_narrative"
    - from: "lib/utils/urgency.ts"
      to: "date-fns"
      via: "differenceInHours, differenceInDays, isPast"
      pattern: "differenceInHours|differenceInDays"
---

<objective>
Install Phase 5 dependencies (react-hook-form, zod, @hookform/resolvers, shadcn form + checkbox + badge), create all budget and submission server actions, extend the webhook route for n8n callbacks, and create the urgency calculation utility.

Purpose: Establish the data layer, form infrastructure, and workflow triggers before building UI. Budget form needs React Hook Form + Zod. Submission checklist needs urgency utilities. All n8n workflow triggers and callbacks must work before UI can consume them.
Output: Server actions for budget CRUD/templates/narrative trigger + submission checklist/submit/history. Webhook route extended with 2 new action cases. Urgency utility for deadline calculations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-budget-builder-submission-tracking/05-RESEARCH.md
@app/api/webhook/route.ts
@app/(dashboard)/proposals/actions.ts
@app/(dashboard)/documents/actions.ts
@lib/supabase/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install form dependencies and add shadcn components</name>
  <files>
    package.json
    package-lock.json
    components/ui/form.tsx
    components/ui/checkbox.tsx
    components/ui/badge.tsx
  </files>
  <action>
    Install React Hook Form, Zod, and the resolver for budget forms:
    ```
    npm install react-hook-form zod @hookform/resolvers
    ```

    Add shadcn form, checkbox, and badge components:
    ```
    npx shadcn@latest add form checkbox badge
    ```

    Verify all three components are created in components/ui/ directory.
    Verify react-hook-form, zod, and @hookform/resolvers are in package.json dependencies.

    IMPORTANT: The shadcn `form` component automatically installs react-hook-form, zod, and @hookform/resolvers as peer dependencies. If `npx shadcn@latest add form` installs them, the separate `npm install` may not be needed. Run the npm install first to ensure correct versions, then add shadcn components.
  </action>
  <verify>
    Run `npm ls react-hook-form zod @hookform/resolvers` to confirm installation.
    Verify `components/ui/form.tsx` exists.
    Verify `components/ui/checkbox.tsx` exists.
    Verify `components/ui/badge.tsx` exists.
    Run `npx tsc --noEmit` to confirm no type errors.
  </verify>
  <done>
    react-hook-form, zod, @hookform/resolvers installed. shadcn form, checkbox, and badge components available in components/ui/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create budget and submission server actions, extend webhook route, create urgency utility</name>
  <files>
    app/(dashboard)/budgets/actions.ts
    app/(dashboard)/submissions/actions.ts
    app/api/webhook/route.ts
    lib/utils/urgency.ts
  </files>
  <action>
    **Create `lib/utils/urgency.ts`** with deadline urgency calculation helpers:

    1. **`calculateUrgency(deadline: Date): UrgencyLevel`** - Returns 'overdue' (isPast), 'critical' (<24h), 'urgent' (<48h), 'soon' (<7d), or 'normal'. Use `differenceInHours` and `differenceInDays` from date-fns (already installed).

    2. **`getUrgencyBadgeVariant(level: UrgencyLevel)`** - Returns shadcn Badge variant: 'destructive' for overdue/critical, 'secondary' for urgent (with custom yellow classes applied in component), 'outline' for soon/normal.

    3. **`getUrgencyLabel(level: UrgencyLevel): string`** - Returns human-readable label: 'Overdue', 'Critical (<24h)', 'Urgent (<48h)', 'Soon (<7d)', 'On Track'.

    Export the `UrgencyLevel` type.

    **Create `app/(dashboard)/budgets/actions.ts`** following the established server action pattern from `proposals/actions.ts`:

    1. **`getBudgets()`** - Fetch all budgets for the user's org where `is_template = false`, join with grants table to get grant title. Return `{ data, error }`. Order by `updated_at` descending.

    2. **`getBudget(budgetId: string)`** - Fetch single budget with its line items (from `budget_line_items` ordered by `sort_order`) and related grant data. Return `{ data: { budget, lineItems, grant }, error }`.

    3. **`createBudget(data: { grant_id: string, name: string, line_items: Array<{ category: string, description: string, amount: number, justification?: string }> })`** - Insert budget row with calculated `total_amount`, then insert all line items with `sort_order` based on array index. Return `{ data: budget, error }`. Use `revalidatePath('/budgets')`.

    4. **`updateBudget(budgetId: string, data: { name?: string, narrative?: string, line_items?: Array<...> })`** - Update budget row. If `line_items` provided, delete existing line items for this budget then insert new ones (simpler than diff for v1). Recalculate `total_amount`. Return `{ success, error }`. Use `revalidatePath('/budgets')`.

    5. **`deleteBudget(budgetId: string)`** - Delete budget (line items cascade). Return `{ success, error }`. Use `revalidatePath('/budgets')`.

    6. **`getBudgetTemplates()`** - Fetch all budgets where `is_template = true` for the user's org. Return `{ data, error }`.

    7. **`saveBudgetAsTemplate(budgetId: string, templateName: string)`** - Fetch the budget and its line items, then insert a new budget row with `is_template: true, name: templateName, grant_id: null` and copy line items. Return `{ success, error }`. Use `revalidatePath('/budgets')`.

    8. **`loadBudgetTemplate(templateId: string)`** - Fetch the template budget with its line items. Return `{ data: { name, lineItems }, error }`. Used by the UI to populate a new budget form.

    9. **`triggerBudgetNarrative(budgetId: string)`** - Follow fire-and-forget pattern:
       - Get authenticated user + org_id from profiles
       - Get budget to find its grant_id
       - Insert `workflow_executions` record with: `{ org_id, grant_id, workflow_name: 'generate-budget', status: 'running', webhook_url: '/webhook/generate-budget' }`
       - Fire-and-forget fetch to `${N8N_WEBHOOK_URL}/generate-budget` with `{ budget_id: budgetId, workflow_id }` payload
       - Headers: `Content-Type: application/json`, `X-Webhook-Secret: ${N8N_WEBHOOK_SECRET}`
       - Return `{ success: true, workflowId }`

    IMPORTANT: The `budgets` table uses `is_template` boolean to distinguish templates from real budgets (not a separate table). The `budget_line_items` table uses `budget_category` enum for the `category` column.

    **Create `app/(dashboard)/submissions/actions.ts`** following the same server action pattern:

    1. **`getSubmissionChecklist(grantId: string)`** - Fetch submission_checklists row for this grant. Checklist items are stored as JSONB in the `items` column (not a separate table). Return `{ data, error }`. If no checklist exists, return `{ data: null, error: null }`.

    2. **`generateChecklist(grantId: string)`** - Fire-and-forget to n8n:
       - Get authenticated user + org_id from profiles
       - Insert `workflow_executions` record with `workflow_name: 'generate-checklist'`
       - Fire-and-forget fetch to `${N8N_WEBHOOK_URL}/generate-checklist` with `{ grant_id: grantId, workflow_id }`
       - Return `{ success: true, workflowId }`

    3. **`updateChecklistItem(checklistId: string, itemIndex: number, completed: boolean)`** - Fetch the checklist, update the specific item in the JSONB `items` array at `itemIndex`, recalculate `completion_percentage`, update the row. Return `{ success, error }`. No revalidatePath (called from optimistic UI).

    4. **`triggerAutoSubmission(grantId: string, portalUrl: string)`** - Fire-and-forget to n8n:
       - Insert `workflow_executions` with `workflow_name: 'auto-submit'`
       - Fire-and-forget fetch to `${N8N_WEBHOOK_URL}/prepare-submission` with `{ grant_id: grantId, portal_url: portalUrl, workflow_id }`
       - Return `{ success: true, workflowId }`

    5. **`logManualSubmission(grantId: string, data: { confirmation_number: string, submitted_at: string, notes?: string })`** - Insert into `submissions` table with `method: 'manual', status: 'completed'`. Return `{ success, error }`. Use `revalidatePath('/submissions')`.

    6. **`getSubmissions(grantId: string)`** - Fetch all submissions for a grant, ordered by `submitted_at` descending. Return `{ data, error }`.

    IMPORTANT: The `submission_checklists` table stores items as JSONB (not separate rows). The expected JSONB structure for items is: `Array<{ label: string, completed: boolean, completed_at?: string }>`. The `submissions` table uses `submission_method` enum ('auto' | 'manual') for the `method` column.

    **Extend `app/api/webhook/route.ts`** by adding these cases to the existing switch statement:

    ```typescript
    case 'insert_budget_narrative': {
      const { budget_id, narrative } = data
      const { error } = await supabase
        .from('budgets')
        .update({ narrative, updated_at: new Date().toISOString() })
        .eq('id', budget_id)
      if (error) throw error
      break
    }

    case 'submission_complete': {
      const { grant_id, org_id, confirmation_number, portal_url, method, notes } = data
      const { error } = await supabase
        .from('submissions')
        .insert({
          grant_id,
          org_id,
          confirmation_number,
          portal_url,
          method: method || 'auto',
          status: 'completed',
          submitted_at: new Date().toISOString(),
          notes,
        })
      if (error) throw error
      break
    }

    case 'insert_checklist': {
      const { grant_id, org_id, items } = data
      const totalItems = items.length
      const completedItems = items.filter((i: any) => i.completed).length
      const completion_percentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0
      const { error } = await supabase
        .from('submission_checklists')
        .upsert({
          grant_id,
          org_id,
          items,
          completion_percentage,
        }, { onConflict: 'grant_id' })
      if (error) throw error
      break
    }
    ```

    Follow the exact same patterns as existing webhook cases: service-role client, throw on error, break after each case.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors.
    Verify `app/(dashboard)/budgets/actions.ts` exports: getBudgets, getBudget, createBudget, updateBudget, deleteBudget, getBudgetTemplates, saveBudgetAsTemplate, loadBudgetTemplate, triggerBudgetNarrative.
    Verify `app/(dashboard)/submissions/actions.ts` exports: getSubmissionChecklist, generateChecklist, updateChecklistItem, triggerAutoSubmission, logManualSubmission, getSubmissions.
    Verify `app/api/webhook/route.ts` contains cases for: insert_budget_narrative, submission_complete, insert_checklist.
    Verify `lib/utils/urgency.ts` exports: calculateUrgency, getUrgencyBadgeVariant, getUrgencyLabel, UrgencyLevel.
  </verify>
  <done>
    All budget/submission server actions created with fire-and-forget webhook pattern. Webhook route extended with 3 new action cases for n8n callbacks. Urgency utility created with date-fns calculations. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npm ls react-hook-form zod @hookform/resolvers` shows installed versions
2. `components/ui/form.tsx`, `components/ui/checkbox.tsx`, `components/ui/badge.tsx` exist
3. `app/(dashboard)/budgets/actions.ts` exports all 9 server actions
4. `app/(dashboard)/submissions/actions.ts` exports all 6 server actions
5. `app/api/webhook/route.ts` handles 13+ action types (10 existing + 3 new)
6. `lib/utils/urgency.ts` exports urgency calculation functions
7. `npx tsc --noEmit` passes with zero errors
</verification>

<success_criteria>
- react-hook-form, zod, @hookform/resolvers installed and importable
- shadcn form, checkbox, badge components available
- All budget server actions follow established patterns (auth check, org_id lookup, fire-and-forget for n8n triggers)
- Budget templates use is_template flag on budgets table (not separate table)
- Submission checklist items stored as JSONB (not separate table)
- Urgency utility correctly calculates overdue/critical/urgent/soon/normal levels
- Webhook route handles n8n callback actions for budget narrative and submission completion
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-budget-builder-submission-tracking/05-01-SUMMARY.md`
</output>
