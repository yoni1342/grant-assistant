---
phase: 05-budget-builder-submission-tracking
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/(dashboard)/submissions/page.tsx
  - app/(dashboard)/submissions/[grantId]/page.tsx
  - app/(dashboard)/submissions/[grantId]/components/submission-page-client.tsx
  - app/(dashboard)/submissions/[grantId]/components/submission-checklist.tsx
  - app/(dashboard)/submissions/[grantId]/components/checklist-item.tsx
  - app/(dashboard)/submissions/[grantId]/components/urgency-badge.tsx
  - app/(dashboard)/submissions/[grantId]/components/auto-submit-button.tsx
  - app/(dashboard)/submissions/[grantId]/components/manual-submit-form.tsx
  - app/(dashboard)/submissions/[grantId]/components/submission-history.tsx
autonomous: true

must_haves:
  truths:
    - "User can see a list of grants with submission status and navigate to submission details"
    - "User can generate a dynamic submission checklist for any grant"
    - "User can check off checklist items with instant visual feedback (optimistic updates)"
    - "User sees deadline urgency indicators (overdue, critical, urgent, soon, normal) with color-coded badges"
    - "User can trigger auto-submission to grant portals via n8n Puppeteer"
    - "User can log a manual submission with confirmation number, date, and notes"
    - "User sees submission history timeline for each grant"
    - "Checklist completion percentage updates as items are checked"
  artifacts:
    - path: "app/(dashboard)/submissions/page.tsx"
      provides: "Submissions list page showing grants with submission status"
      min_lines: 15
    - path: "app/(dashboard)/submissions/[grantId]/page.tsx"
      provides: "Submission detail page (server component)"
      min_lines: 20
    - path: "app/(dashboard)/submissions/[grantId]/components/submission-checklist.tsx"
      provides: "Checklist display with urgency badge and completion percentage"
      min_lines: 40
    - path: "app/(dashboard)/submissions/[grantId]/components/checklist-item.tsx"
      provides: "Single checkbox item with optimistic update and rollback"
      min_lines: 25
    - path: "app/(dashboard)/submissions/[grantId]/components/urgency-badge.tsx"
      provides: "Deadline urgency badge component using lib/utils/urgency.ts"
      min_lines: 10
    - path: "app/(dashboard)/submissions/[grantId]/components/manual-submit-form.tsx"
      provides: "React Hook Form for logging manual submission"
      min_lines: 50
    - path: "app/(dashboard)/submissions/[grantId]/components/submission-history.tsx"
      provides: "Timeline display of submission events"
      min_lines: 40
  key_links:
    - from: "app/(dashboard)/submissions/[grantId]/components/checklist-item.tsx"
      to: "app/(dashboard)/submissions/actions.ts"
      via: "updateChecklistItem server action with optimistic state + rollback"
      pattern: "updateChecklistItem"
    - from: "app/(dashboard)/submissions/[grantId]/components/urgency-badge.tsx"
      to: "lib/utils/urgency.ts"
      via: "calculateUrgency and getUrgencyBadgeVariant"
      pattern: "calculateUrgency|getUrgencyBadgeVariant"
    - from: "app/(dashboard)/submissions/[grantId]/components/auto-submit-button.tsx"
      to: "app/(dashboard)/submissions/actions.ts"
      via: "triggerAutoSubmission server action with fire-and-forget"
      pattern: "triggerAutoSubmission"
    - from: "app/(dashboard)/submissions/[grantId]/components/manual-submit-form.tsx"
      to: "app/(dashboard)/submissions/actions.ts"
      via: "logManualSubmission server action on form submit"
      pattern: "logManualSubmission"
---

<objective>
Build the Submission Tracking UI: submissions list page, submission detail page per grant with dynamic checklist (optimistic checkbox updates), deadline urgency badges, auto-submit trigger, manual submission form, and submission history timeline.

Purpose: Users need to track submission progress per grant, complete checklist items, see deadline urgency at a glance, and submit via automation or manual logging. This completes the grant lifecycle from proposal to submission.
Output: Full submission tracking UI with checklist, urgency indicators, dual-mode submission, and history timeline.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-budget-builder-submission-tracking/05-RESEARCH.md
@.planning/phases/05-budget-builder-submission-tracking/05-01-SUMMARY.md
@app/(dashboard)/submissions/actions.ts
@lib/utils/urgency.ts
@app/(dashboard)/pipeline/[id]/components/workflow-progress.tsx
@lib/supabase/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create submissions list page and grant submission detail page</name>
  <files>
    app/(dashboard)/submissions/page.tsx
    app/(dashboard)/submissions/[grantId]/page.tsx
    app/(dashboard)/submissions/[grantId]/components/submission-page-client.tsx
    app/(dashboard)/submissions/[grantId]/components/urgency-badge.tsx
  </files>
  <action>
    **Replace `app/(dashboard)/submissions/page.tsx`** (currently placeholder) with a server component:
    - Fetch all grants for the user's org from Supabase (using server-side createClient), ordered by deadline ascending (soonest first)
    - For each grant, also fetch its submission_checklists and submissions counts via a join or separate queries
    - Render a page header "Submissions" with description text
    - Render a list/table of grants showing: Grant Title (link to `/submissions/{grantId}`), Deadline (formatted date), Urgency Badge (using urgency util on deadline), Checklist Status (e.g., "3/5 items" or "No checklist"), Submission Status (e.g., "Submitted", "Not submitted")
    - This can be a simple server-rendered table (no TanStack Table needed -- simpler than budgets list since it's a navigation page)
    - Empty state: "No grants in your pipeline. Add grants to start tracking submissions."

    **Create `app/(dashboard)/submissions/[grantId]/components/urgency-badge.tsx`**:
    - Client component that receives a `deadline: string` prop (ISO date string from database)
    - Converts to Date object, calls `calculateUrgency(deadline)` from `lib/utils/urgency.ts`
    - Calls `getUrgencyBadgeVariant(urgency)` and `getUrgencyLabel(urgency)`
    - Renders shadcn `Badge` with appropriate variant
    - For 'urgent' level, add custom className `bg-yellow-500 text-white` since shadcn Badge doesn't have a yellow variant by default

    **Create `app/(dashboard)/submissions/[grantId]/page.tsx`** as a server component:
    - Extract `grantId` from route params
    - Fetch grant data (title, deadline, funder_name, portal_url from `source_url` field)
    - Fetch submission checklist via `getSubmissionChecklist(grantId)` server action
    - Fetch submissions history via `getSubmissions(grantId)` server action
    - If grant not found, show not-found message
    - Render `SubmissionPageClient` with grant, checklist, and submissions data

    **Create `app/(dashboard)/submissions/[grantId]/components/submission-page-client.tsx`** as a client component wrapper:
    - Receives grant, checklist, and submissions as props
    - Page layout with grant title and urgency badge at top
    - Two-column layout on desktop (single column on mobile):
      - Left column: Submission Checklist section + Auto-Submit / Manual Submit buttons section
      - Right column: Submission History timeline
    - "Generate Checklist" button shown if no checklist exists -- calls `generateChecklist()` server action and shows WorkflowProgress (reuse from pipeline)
    - Realtime subscription on `submission_checklists` table filtered by grant_id for live checklist updates (when n8n generates checklist). Also subscribe to `submissions` table for live submission status updates. On any change, call `router.refresh()`.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors.
    Verify `app/(dashboard)/submissions/page.tsx` fetches grants and renders urgency badges.
    Verify `app/(dashboard)/submissions/[grantId]/page.tsx` fetches grant, checklist, and submissions data.
    Verify `app/(dashboard)/submissions/[grantId]/components/submission-page-client.tsx` has Realtime subscriptions and layout.
    Verify `app/(dashboard)/submissions/[grantId]/components/urgency-badge.tsx` uses calculateUrgency from lib/utils/urgency.ts.
  </verify>
  <done>
    Submissions list page shows all grants with deadline urgency and submission status. Grant submission detail page renders checklist, action buttons, and history with Realtime updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create checklist items, auto-submit button, manual submission form, and submission history</name>
  <files>
    app/(dashboard)/submissions/[grantId]/components/submission-checklist.tsx
    app/(dashboard)/submissions/[grantId]/components/checklist-item.tsx
    app/(dashboard)/submissions/[grantId]/components/auto-submit-button.tsx
    app/(dashboard)/submissions/[grantId]/components/manual-submit-form.tsx
    app/(dashboard)/submissions/[grantId]/components/submission-history.tsx
  </files>
  <action>
    **Create `app/(dashboard)/submissions/[grantId]/components/submission-checklist.tsx`**:
    - Receives `checklist` (submission_checklists row) as prop, with `items` as the JSONB array
    - Type the items as `Array<{ label: string, completed: boolean, completed_at?: string }>`
    - Renders header "Submission Checklist" with completion percentage displayed as a progress bar (reuse shadcn Progress component from Phase 4)
    - Completion text: "X of Y items complete (Z%)"
    - Maps over items array, rendering `ChecklistItem` for each item
    - Pass `checklistId` and `itemIndex` to each ChecklistItem for optimistic updates

    **Create `app/(dashboard)/submissions/[grantId]/components/checklist-item.tsx`**:
    - Receives `id: string` (checklist row id), `itemIndex: number`, `label: string`, `initialChecked: boolean` as props
    - Implements optimistic checkbox toggle pattern from research:
      1. Local state: `const [checked, setChecked] = useState(initialChecked)`
      2. `useTransition` for non-blocking server action call
      3. On checkbox change: set `checked` immediately (optimistic), then call `updateChecklistItem(id, itemIndex, newChecked)` server action in transition
      4. On error: rollback to `!newChecked`
    - Renders shadcn `Checkbox` component with label
    - When checked, label has `line-through text-muted-foreground` styles
    - Checkbox disabled during transition (isPending)

    **Create `app/(dashboard)/submissions/[grantId]/components/auto-submit-button.tsx`**:
    - Receives `grantId: string` and `portalUrl: string | null` as props
    - "Auto-Submit" button that calls `triggerAutoSubmission(grantId, portalUrl)` server action
    - If `portalUrl` is null/empty, button is disabled with tooltip "No portal URL available for this grant"
    - After triggering, show WorkflowProgress component (reuse from pipeline) to track submission progress
    - Loading state with spinner while triggering
    - Use lucide `Upload` icon on button

    **Create `app/(dashboard)/submissions/[grantId]/components/manual-submit-form.tsx`**:
    - React Hook Form with Zod validation:
      ```
      manualSubmissionSchema: {
        confirmation_number: string min(1, 'Confirmation number required'),
        submitted_at: string (datetime-local format),
        notes: string optional
      }
      ```
    - `useForm` with `zodResolver(manualSubmissionSchema)`
    - Form fields: Confirmation Number (Input), Submission Date/Time (Input type="datetime-local" with default to current date/time), Notes (Textarea, optional)
    - On submit, call `logManualSubmission(grantId, data)` server action
    - On success, reset form with `form.reset()`
    - "Log Submission" button with FileCheck icon
    - Use shadcn Form components (FormField, FormItem, FormLabel, FormControl, FormMessage) throughout
    - Wrap in a collapsible section or card with header "Log Manual Submission"

    **Create `app/(dashboard)/submissions/[grantId]/components/submission-history.tsx`**:
    - Receives `submissions` array (from submissions table) as prop
    - Timeline layout with left border line and event dots (CSS-based timeline, not a library)
    - Each submission event shows:
      - Icon based on method: Upload icon for auto, FileCheck icon for manual
      - Badge with method label ("Auto-Submitted" or "Manual Submission")
      - Timestamp formatted with `formatDistanceToNow(submitted_at, { addSuffix: true })` from date-fns
      - Confirmation number (if exists)
      - Status badge (completed = green, pending = gray, failed = red)
      - Notes (if exists, in smaller text)
    - Events ordered by submitted_at descending (most recent first)
    - Empty state: "No submissions yet."
    - Use lucide icons: CheckCircle2, Clock, Upload, FileCheck

    IMPORTANT patterns to follow:
    - Optimistic updates: setState immediately, then server action in useTransition, rollback on error
    - Fire-and-forget for auto-submission (same as proposal generation pattern)
    - Reuse WorkflowProgress component from pipeline for both checklist generation and auto-submission tracking
    - shadcn Form components for manual submission form (consistent with budget form)
    - Timeline uses CSS borders and positioning (no external timeline library needed)
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors.
    Verify `checklist-item.tsx` uses useState + useTransition for optimistic updates with rollback.
    Verify `auto-submit-button.tsx` calls `triggerAutoSubmission` and shows WorkflowProgress.
    Verify `manual-submit-form.tsx` uses React Hook Form + Zod with shadcn Form components.
    Verify `submission-history.tsx` renders timeline with method icons and status badges.
    Verify `submission-checklist.tsx` renders progress bar with completion percentage.
  </verify>
  <done>
    Submission checklist with optimistic checkbox updates and progress bar, auto-submit button with workflow tracking, manual submission form with validation, and submission history timeline with method/status indicators. All components follow established patterns.
  </done>
</task>

</tasks>

<verification>
1. Submissions list at `/submissions` shows grants with deadline urgency and submission status
2. Grant submission page at `/submissions/{grantId}` shows checklist, actions, and history
3. "Generate Checklist" triggers n8n and checklist appears via Realtime
4. Checking off items updates immediately (optimistic) with rollback on error
5. Completion percentage and progress bar update as items are checked
6. Urgency badges show correct colors for overdue/critical/urgent/soon/normal
7. "Auto-Submit" triggers n8n Puppeteer workflow and shows progress
8. Manual submission form validates and logs submission with confirmation number
9. Submission history shows timeline of all submissions with method and status
10. `npx tsc --noEmit` passes with zero errors
</verification>

<success_criteria>
- Users can view grants by submission urgency and navigate to submission details
- Dynamic checklist with optimistic checkbox updates provides instant feedback
- Deadline urgency badges clearly communicate time pressure (color-coded)
- Auto-submission triggers n8n Puppeteer workflow via fire-and-forget pattern
- Manual submission captures confirmation number, date, and notes
- Submission history displays chronological events with method/status indicators
- Realtime updates when n8n completes checklist generation or submission
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-budget-builder-submission-tracking/05-03-SUMMARY.md`
</output>
