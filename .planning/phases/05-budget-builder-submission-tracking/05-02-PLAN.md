---
phase: 05-budget-builder-submission-tracking
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/(dashboard)/budgets/page.tsx
  - app/(dashboard)/budgets/components/budget-table.tsx
  - app/(dashboard)/budgets/components/budget-page-client.tsx
  - app/(dashboard)/budgets/new/page.tsx
  - app/(dashboard)/budgets/components/budget-form.tsx
  - app/(dashboard)/budgets/components/template-selector.tsx
  - app/(dashboard)/budgets/[id]/page.tsx
  - app/(dashboard)/budgets/[id]/components/budget-detail-client.tsx
autonomous: true

must_haves:
  truths:
    - "User can see a list of all budgets with grant name, total amount, and narrative status"
    - "User can create a new budget with dynamic line items (add/remove rows)"
    - "User can load a budget template to pre-populate line items on new budget form"
    - "User can view and edit an existing budget's line items and narrative"
    - "User can trigger AI budget narrative generation from the budget detail page"
    - "User can save a budget as a template for reuse"
    - "Budget total recalculates in real-time as line item amounts change"
    - "Budget line item categories use the budget_category enum (personnel, fringe, travel, etc.)"
  artifacts:
    - path: "app/(dashboard)/budgets/page.tsx"
      provides: "Budget list page (server component)"
      min_lines: 15
    - path: "app/(dashboard)/budgets/components/budget-table.tsx"
      provides: "TanStack table for budget list display"
      min_lines: 60
    - path: "app/(dashboard)/budgets/components/budget-form.tsx"
      provides: "React Hook Form with useFieldArray for dynamic budget line items"
      min_lines: 100
    - path: "app/(dashboard)/budgets/new/page.tsx"
      provides: "New budget page with form and template selector"
      min_lines: 15
    - path: "app/(dashboard)/budgets/[id]/page.tsx"
      provides: "Budget detail page (server component)"
      min_lines: 15
    - path: "app/(dashboard)/budgets/[id]/components/budget-detail-client.tsx"
      provides: "Budget detail client component with edit form, narrative display, and action buttons"
      min_lines: 80
  key_links:
    - from: "app/(dashboard)/budgets/components/budget-form.tsx"
      to: "app/(dashboard)/budgets/actions.ts"
      via: "createBudget/updateBudget server actions called on form submit"
      pattern: "createBudget|updateBudget"
    - from: "app/(dashboard)/budgets/components/template-selector.tsx"
      to: "app/(dashboard)/budgets/actions.ts"
      via: "loadBudgetTemplate server action to populate form"
      pattern: "loadBudgetTemplate"
    - from: "app/(dashboard)/budgets/[id]/components/budget-detail-client.tsx"
      to: "app/(dashboard)/budgets/actions.ts"
      via: "triggerBudgetNarrative and saveBudgetAsTemplate server actions"
      pattern: "triggerBudgetNarrative|saveBudgetAsTemplate"
    - from: "app/(dashboard)/budgets/components/budget-form.tsx"
      to: "react-hook-form"
      via: "useForm, useFieldArray, useWatch for dynamic line items"
      pattern: "useFieldArray|useWatch"
---

<objective>
Build the Budget Builder UI: budget list page with TanStack table, new budget form with React Hook Form useFieldArray for dynamic line items, template loading, budget detail page with edit form and AI narrative trigger.

Purpose: Users need to create, view, and edit budgets with dynamic line items before submission. AI narrative generation adds justification text to budget. Templates save time on repeated budget structures.
Output: Full budget management UI with list, create, edit, template, and AI narrative features.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-budget-builder-submission-tracking/05-RESEARCH.md
@.planning/phases/05-budget-builder-submission-tracking/05-01-SUMMARY.md
@app/(dashboard)/budgets/actions.ts
@app/(dashboard)/proposals/components/proposals-page-client.tsx
@app/(dashboard)/proposals/components/proposal-table.tsx
@app/(dashboard)/documents/components/document-table.tsx
@lib/supabase/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create budget list page with TanStack table</name>
  <files>
    app/(dashboard)/budgets/page.tsx
    app/(dashboard)/budgets/components/budget-table.tsx
    app/(dashboard)/budgets/components/budget-page-client.tsx
  </files>
  <action>
    **Replace `app/(dashboard)/budgets/page.tsx`** (currently placeholder) with a server component that fetches budgets via `getBudgets()` server action and renders `BudgetPageClient`.

    **Create `app/(dashboard)/budgets/components/budget-page-client.tsx`** as a client component wrapper:
    - Receives budgets array as prop from server page
    - Renders page header "Budgets" with a "New Budget" link (Next.js Link to `/budgets/new`)
    - Renders `BudgetTable` with budgets data
    - Sets up Supabase Realtime subscription on `budgets` table for live updates (INSERT, UPDATE, DELETE) following the pattern from `proposals-page-client.tsx` -- on any change, call `router.refresh()` to reload server data

    **Create `app/(dashboard)/budgets/components/budget-table.tsx`** as a TanStack Table following the `proposal-table.tsx` pattern:
    - Columns: Budget Name (link to `/budgets/{id}`), Grant Title (from joined grant data, or "Template" if is_template), Total Amount (formatted as currency with `$X,XXX`), Narrative Status (badge: "Generated" green if narrative exists, "Pending" gray if not), Updated date (formatted with date-fns `formatDistanceToNow`)
    - Include global filter for search across budget name and grant title
    - Row click navigates to `/budgets/{id}`
    - Empty state: "No budgets yet. Create your first budget."

    Follow the same TanStack Table patterns established in document-table.tsx and proposal-table.tsx:
    - `useReactTable` with `getCoreRowModel`, `getFilteredRowModel`, `getSortedRowModel`
    - Column definitions with `columnHelper.accessor`
    - Global filter input above table
    - Sortable column headers
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors.
    Verify `app/(dashboard)/budgets/page.tsx` imports and calls `getBudgets()`.
    Verify `app/(dashboard)/budgets/components/budget-table.tsx` defines columns for name, grant, amount, narrative status, updated date.
    Verify `app/(dashboard)/budgets/components/budget-page-client.tsx` sets up Realtime subscription.
  </verify>
  <done>
    Budget list page renders TanStack table with budget data, search filter, sortable columns, and Realtime subscription for live updates. "New Budget" button links to creation form.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create budget form with dynamic line items, template selector, and detail page</name>
  <files>
    app/(dashboard)/budgets/new/page.tsx
    app/(dashboard)/budgets/components/budget-form.tsx
    app/(dashboard)/budgets/components/template-selector.tsx
    app/(dashboard)/budgets/[id]/page.tsx
    app/(dashboard)/budgets/[id]/components/budget-detail-client.tsx
  </files>
  <action>
    **Create `app/(dashboard)/budgets/components/budget-form.tsx`** using React Hook Form with useFieldArray:
    - Zod schema for validation:
      ```
      lineItemSchema: { category: budget_category enum, description: string min(1), amount: coerce.number min(0), justification: string optional }
      budgetSchema: { grant_id: string uuid, name: string min(1), line_items: array(lineItemSchema) min(1) }
      ```
    - `useForm` with `zodResolver(budgetSchema)`
    - `useFieldArray` on `line_items` field for dynamic add/remove rows
    - `useWatch` on `line_items` for reactive total calculation (NOT `watch()` in `useEffect` -- causes infinite loops)
    - Each line item row shows: category (Select dropdown with budget_category enum values: personnel, fringe, travel, equipment, supplies, contractual, other, indirect), description (Input), amount (Input type="number"), justification (Input, optional), and a remove button (Trash2 icon)
    - "Add Line Item" button using `append({ category: '', description: '', amount: 0, justification: '' })`
    - Use `field.id` as React key (NOT array index -- breaks reconciliation on remove)
    - Total displayed below line items, formatted as currency
    - Props: `grantId?: string`, `defaultValues?` (for edit mode), `templates` (for template selector), `onSubmit: (data) => Promise<void>`
    - If `defaultValues` provided, populate form with existing budget data (edit mode)
    - Renders `TemplateSelector` above the line items section when creating new budget (not in edit mode)
    - Use shadcn Form components (FormField, FormItem, FormLabel, FormControl, FormMessage) throughout
    - Submit button: "Create Budget" or "Save Changes" depending on mode

    **Create `app/(dashboard)/budgets/components/template-selector.tsx`**:
    - Receives `templates` array and `form` (UseFormReturn) as props
    - shadcn Select dropdown showing template names
    - On select, call `loadBudgetTemplate(templateId)` server action
    - Use `form.reset()` to populate line items from template data, mapping template line items to match form schema
    - Show empty state if no templates exist

    **Create `app/(dashboard)/budgets/new/page.tsx`** as a server component:
    - Fetch budget templates via `getBudgetTemplates()`
    - Fetch grants via supabase query for a grant picker (user selects which grant the budget is for)
    - Render page header "New Budget"
    - Render a grant selector (Select dropdown with grant titles) and `BudgetForm` with selected grant_id
    - On form submit, call `createBudget()` server action then redirect to `/budgets`
    - This needs a client wrapper to manage grant selection state and form submission

    **Create `app/(dashboard)/budgets/[id]/page.tsx`** as a server component:
    - Fetch budget with line items via `getBudget(params.id)`
    - Handle not found case with redirect or error message
    - Render `BudgetDetailClient` with budget, line items, and grant data

    **Create `app/(dashboard)/budgets/[id]/components/budget-detail-client.tsx`** as a client component:
    - Renders `BudgetForm` in edit mode with existing budget data as defaultValues
    - On form submit, call `updateBudget()` server action
    - Action buttons section:
      1. "Generate Narrative" button -- calls `triggerBudgetNarrative()`, shows WorkflowProgress component (reuse from `app/(dashboard)/pipeline/[id]/components/workflow-progress.tsx`) while generating
      2. "Save as Template" button -- opens a small dialog/popover asking for template name, then calls `saveBudgetAsTemplate()`
      3. "Delete Budget" button -- confirmation dialog, then calls `deleteBudget()` and redirects to `/budgets`
    - Narrative display section: if `budget.narrative` exists, render it below the form in a styled card. Use a simple prose-styled div (no Tiptap needed for narrative -- it's read-only AI-generated text). If no narrative, show empty state "No narrative generated yet."
    - Realtime subscription on `budgets` table filtered by budget id for live narrative updates (when n8n completes narrative generation). On update, call `router.refresh()`.

    IMPORTANT patterns to follow:
    - Use `useWatch` (not `watch()` in useEffect) for total calculation
    - Use `field.id` (not index) as React key in line items
    - Follow shadcn Form component pattern exactly (FormField > render > FormItem > FormLabel + FormControl + FormMessage)
    - Fire-and-forget pattern for narrative trigger (same as proposal generation)
    - Reuse WorkflowProgress component from pipeline for generation tracking
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors.
    Verify `app/(dashboard)/budgets/components/budget-form.tsx` uses `useFieldArray`, `useWatch`, and Zod validation.
    Verify `app/(dashboard)/budgets/components/template-selector.tsx` calls `loadBudgetTemplate` and `form.reset`.
    Verify `app/(dashboard)/budgets/new/page.tsx` renders budget form with grant selector.
    Verify `app/(dashboard)/budgets/[id]/page.tsx` fetches budget data and renders detail client.
    Verify `app/(dashboard)/budgets/[id]/components/budget-detail-client.tsx` has narrative trigger, save-as-template, and delete buttons.
  </verify>
  <done>
    Budget form with dynamic line items (add/remove) using React Hook Form useFieldArray, real-time total calculation via useWatch, template selector for pre-populating forms, and budget detail page with edit form, AI narrative trigger with workflow progress, save-as-template, and delete functionality.
  </done>
</task>

</tasks>

<verification>
1. Budget list page at `/budgets` shows TanStack table with all budgets
2. "New Budget" page at `/budgets/new` renders form with grant selector and template loader
3. Budget form supports adding/removing line items dynamically
4. Total amount recalculates as line item amounts change
5. Template selector loads template line items into form
6. Budget detail page at `/budgets/{id}` shows edit form with existing data
7. "Generate Narrative" triggers n8n workflow and shows progress
8. "Save as Template" saves budget structure as reusable template
9. AI-generated narrative displays below budget form when available
10. `npx tsc --noEmit` passes with zero errors
</verification>

<success_criteria>
- Users can create budgets with dynamic line items using React Hook Form useFieldArray
- Budget total recalculates in real-time using useWatch (not watch() in useEffect)
- Budget templates load line item structure into new budget form
- Budget detail page shows edit form + AI narrative + action buttons
- All budget CRUD operations work via server actions
- Realtime updates when n8n completes narrative generation
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-budget-builder-submission-tracking/05-02-SUMMARY.md`
</output>
